layui.use(["jquery","yunj","elemProgress"],function(){let s=window;let t=document;let n=layui.jquery;let i=layui.elemProgress;class r{constructor(t){this.id=t.id;this.rawEl=t.elem;this.rawArgs=t.args;this.boxEl=null;this.btnBoxEl=null;this.stepBoxEl=null;this.contentBoxEl=null;this.stepNames=["one","two","three"];this.stepMap={};this.step="";this.defaultSheetName="Sheet1";this.DataStateEnum={ERROR:{code:"error",tips:"数据错误"},WAIT:{code:"wait",tips:"等待导入"},IMPORTING:{code:"importing",tips:"正在导入"},SUCCESS:{code:"success",tips:"导入成功"},FAIL:{code:"fail",tips:"导入失败"}};this._init().catch(t=>{console.log(t);yunj.error(t)})}async _init(){let e=this;if(!e.id||!e.rawArgs||yunj.isEmptyObj(e.rawArgs))throw new Error("导入构建器参数异常");await e._initData();let s=i({elem:e.boxEl});e.setCurrStep(e.stepNames[0]).then(t=>{e.setEventBind();s.reset_progress(100)})}rawArgsIsSetAttr(t){return this.rawArgs.hasOwnProperty(t)}isSetSheet(){return this.rawArgsIsSetAttr("sheet")}isSetCols(){return this.rawArgsIsSetAttr("cols")}isSetTemplet(){return this.rawArgsIsSetAttr("templet")&&this.rawArgs.templet}async _initData(){let n=this;n._setBoxEl();for(let i=0,t=n.stepNames.length;i<t;i++){let t=n.stepNames[i].slice(0,1).toUpperCase()+n.stepNames[i].slice(1);let e=`ImportStep${t}`;let s=await new Promise(t=>{layui.use(e,()=>{t(new layui[e](n))})});n.stepMap[s.name]=s}}_setBoxEl(){let t=this;let e=false;let s="";t.rawArgs.tips.forEach((t,e)=>s+=`<li>${e+1}. ${t}</li>`);let i=`<div class="yunj-import-box ${e?"head-fixed":""}" id="yunj_import_${t.id}">
                            <div class="yunj-import-header">
                                <div class="yunj-import-btn-box">
                                    <button type="button" class="layui-btn layui-btn-sm layui-btn-primary btn-import-prev">上一步</button>
                                    <button type="button" class="layui-btn layui-btn-sm btn-import-next">下一步</button>
                                </div>
                                <div class="yunj-import-step-box"></div>
                            </div>
                            <div class="yunj-import-content-box"></div>
                        </div>`;t.rawEl.after(i);t.boxEl=n(`#yunj_import_${t.id}`);t.btnBoxEl=t.boxEl.find(".yunj-import-btn-box");t.stepBoxEl=t.boxEl.find(".yunj-import-step-box");t.contentBoxEl=t.boxEl.find(".yunj-import-content-box")}async setCurrStep(t,e=false){let s=this;s.step=t;await s.stepMap[t].render(e);s.btnBoxEl.find(".layui-btn").removeClass("active");s.stepBoxEl.children(".item").removeClass("finish").removeClass("curr");s.contentBoxEl.find(".yunj-import-step-content").removeClass("active");if(t!=="one"){s.btnBoxEl.find(".btn-import-prev").addClass("active")}if(t!=="three"){s.btnBoxEl.find(".btn-import-next").addClass("active")}let i=s.stepBoxEl.children(`.item[data-step=${t}]`);i.prevAll(".item").addClass("finish");i.addClass("curr");s.contentBoxEl.find(`.yunj-import-step-content[data-step=${t}]`).addClass("active")}importEnd(){this.stepMap.three.importEnd()}isImporting(){this.stepMap.three.isImporting}next(){let e=this;let t=e.step;let s=e.stepNames.indexOf(t);if(s===false||s+1>=e.stepNames)return;let i=e.stepNames[s+1];e.setCurrStep(i,true).catch(t=>{console.log(t);yunj.error(t);e.prev()})}prev(){let e=this;let t=e.step;let s=e.stepNames.indexOf(t);if(s===false||s<=0)return;let i=()=>{let t=e.stepNames[s-1];e.setCurrStep(t).catch(t=>{console.log(t)})};if(t!=="three"){i();return}if(e.isImporting()){yunj.confirm("正在进行数据导入，返回上一步将终止导入过程。是否继续",()=>{e.importEnd();i()})}else{i()}}setEventBind(){let s=this;for(let t=0,e=s.stepNames.length;t<e;t++){s.stepMap[s.stepNames[t]].setEventBind()}s.btnBoxEl.on("click",".btn-import-next",function(){s.next()});s.btnBoxEl.on("click",".btn-import-prev",function(){s.prev()})}}n(t).ready(function(){s.yunj.import={};let t=n("import[type=yunj]");if(yunj.isUndefined(YUNJ_IMPORT)||!yunj.isObj(YUNJ_IMPORT)||t.length<=0)return;yunj.includeCss(`/static/yunj/css/import.min.css?v=${YUNJ_VERSION}`).then(()=>{yunj.includeXlsxStyle().then(()=>{t.each(function(){let t=n(this).attr("id");if(!YUNJ_IMPORT.hasOwnProperty(t))return true;let e=YUNJ_IMPORT[t];s.yunj.import[t]=new r({id:t,elem:n(this),args:e})})})})})});