layui.define(["jquery","yunj","ImportStepTypeTable","validate"],function(e){let t=window;let r=document;let i=layui.jquery;let l=layui.ImportStepTypeTable;let d=layui.validate;class a extends l{constructor(e){super(e,"two","数据确认");this.dataId=1;this.typeSort=["normal","error"];this.typeConfig={normal:{desc:"可选数据"},error:{desc:"错误数据"}};this.currType="normal"}async render(e=false){let t=this;let r=t.getCurrUploadFile();if(!r){throw new Error("请选择上传文件")}if(!e){return}t.initData();t.setContentBoxHtml();await t.handleItems(r);t.setCurrType("normal")}handleItems(e){let o=this;return new Promise((l,a)=>{let t=new FileReader;t.onerror=function(e){a(`无法读取文件！<br>${t.error}`)};t.onload=function(e){let t=e.target.result;let r=XLSX.read(t,{type:"binary"});o.dataId=1;try{if(o.isSetSheet()){r.SheetNames.forEach(e=>{if(e===o.importObj.stepMap.one.templetDescSheetName){return}o.handleUploadFileSheetData(r.Sheets[e],e)})}else{o.handleUploadFileSheetData(r.Sheets[o.importObj.defaultSheetName])}}catch(e){a(e.message);console.log(e)}yunj.isEmptyObj(o.typeAllItems)?a("上传文件数据格式错误，详见示例模板"):l()};t.readAsBinaryString(e)})}handleUploadFileSheetData(e,i=false){let n=this;let t={defval:""};let s=XLSX.utils.sheet_to_json(e,t);let c=n.getCols(i);if(yunj.isEmptyObj(c)){return}for(let r=0,e=s.length;r<e;r++){let l=s[r];let a={_id:n.dataId++,_sheet:i,LAY_CHECKED:false,LAY_DISABLED:false,_rowIdx:r+1,_rowData:l};let o=true;for(let r in c){if(!c.hasOwnProperty(r)){continue}let e=c[r].title;if(!l.hasOwnProperty(e)){throw new Error("上传文件数据格式错误，详见示例模板")}let t=l[e];if(yunj.isString(t)){t=yunj.trim(t)}if(t!==""){o=false}a[r]=t}if(o){continue}let e=n.getColsValidateAttr(i);d.create({rule:e.rule,batch:true});let t=d.check(a,e.dataTitle);if(!t){a._error=d.getFieldError();n.addErrorItem(a)}else{n.addNormalItem(a)}}}addNormalItem(e){let t=this;e.LAY_CHECKED=true;t.addTypeItem("normal",e)}addErrorItem(e){let t=this;e.LAY_CHECKED=false;t.addTypeItem("error",e)}delNormalItem(e){let t=this;t.delTypeItem("normal",e)}delErrorItem(e){let t=this;t.delTypeItem("error",e)}getNormalItemsCount(){let e=this;return e.getTypeItemsCount("normal")}getErrorItemsCount(){let e=this;return e.getTypeItemsCount("error")}renderNormalActionHtml(){let t=this;let e=t.getCurrTypeActionFormId();let r=t.getTypeCheckAllFilter("normal");t.typeActionEl.append(`<div class="action normal">
                                        <div class="tips">选中<em class="check-count">0</em>条</div>
                                        <form class="layui-form layui-form-pane" lay-filter="${e}">
                                            <div class="layui-form-item" style="margin: 0">
                                                <input type="checkbox" title="全选" lay-filter="${r}">
                                            </div>
                                        </form>
                                    </div>`);t.layForm.render("checkbox",e);t.layForm.on(`checkbox(${r})`,function(e){t.setCurrTypeTabTablesCheckAll(e.elem.checked)});t.typeActionEl.find(`.action.normal input[type=checkbox][lay-filter='${r}']`).prop("checked",false);t.layForm.render("checkbox",e)}renderErrorActionHtml(){let t=this;let e=t.getCurrTypeActionFormId();let r=t.getTypeCheckAllFilter("error");t.typeActionEl.append(`<div class="action error">
                                        <div class="tips"><span class="notice">注意：点击表格可修改数据并验证提交！</span>选中<em class="check-count">0</em>条</div>
                                        <form class="layui-form layui-form-pane" lay-filter="${e}">
                                            <div class="layui-form-item" style="margin: 0">
                                                <input type="checkbox" title="全选" lay-filter="${r}">
                                                <button type="button" class="layui-btn layui-btn-sm btn-check-submit">验证/提交至可选</button>
                                            </div>
                                        </form>
                                    </div>`);t.layForm.render("checkbox",e);t.layForm.on(`checkbox(${r})`,function(e){t.setCurrTypeTabTablesCheckAll(e.elem.checked)});t.typeActionEl.find(`.action.error input[type=checkbox][lay-filter='${r}']`).prop("checked",false);t.layForm.render("checkbox",e);t.contentBoxEl.on("click",".type-action .action.error .btn-check-submit",function(e){t.errorItemsCheckSubmit();e.stopPropagation()})}getTypeTabTableTabTitleAppendHtml(e,t){let r=this;return`<span class="layui-badge check-count ${e==="normal"?"layui-bg-green":""}">0</span>`}getTypeTabTableCols(r,e=false){let t=this;let l=t.getCols(e);let a=[{field:"_id",type:"checkbox",LAY_CHECKED:r==="normal"}];for(let t in l){if(!l.hasOwnProperty(t)){continue}let e={field:t,type:"normal",title:l[t].title};if(r==="error"){e.edit="text";e.templet=function(e){if(e._error.hasOwnProperty(t)){return`<div class="error-cell" title="${e._error[t]}" data-field="${t}" data-row-data='${JSON.stringify(e)}'>${e[t]}</div>`}return e[t]}}a.push(e)}return a}renderTypeTabTableDone(e,t,r){let l=this;l.layTable.resize(e.id);l.setTypeTabTablesCheckCount(t);l.layTable.on(`checkbox(${e.id})`,function(e){if(e.type==="all"){l.setItemsChecked(e.checked,t,r)}else{l.setItemChecked(e.checked,t,e.data)}l.setTypeTabTablesCheckCount(t)});let a=l.typeTabTablesEl.find(`.layui-table-view[lay-id=${this.id}] .layui-table-header thead:first tr:first th:first .layui-form-checkbox`);let o=a.hasClass("layui-form-checked");if(o){a.click()}}errorItemsCheckSubmit(){let r=this;super.typeTabTableItemsCheckSubmit("error",e=>{delete e._error;r.delErrorItem(e);r.addNormalItem(e)},(e,t)=>{e._error=t.getFieldError();r.changeItem(e)},(e,t)=>{if(e){r.reloadTypeHtml("error");r.setTypeTabTablesCheckCount("error");r.reloadTypeHtml("normal");r.setTypeTabTablesCheckCount("normal")}if(t){yunj.msg(`仍有${t}条数据错误，请修改后重新提交`)}})}errorCellCheck(e){let t=this;super.checkCellData(e,(e,t,r)=>{e._error[t]=r.getError()})}getCheckedImportItems(){let a=this;let o;let l=a.typeTabTablesEl.find(".tab-tables.normal .layui-tab-item > .layui-table");if(l.length<=0){throw new Error("上传文件数据异常")}if(a.isSetSheet()){o={};l.each(function(){let e=i(this);let t=e.attr("id");let r=e.data("sheet");let l=a.layTable.checkStatus(t).data;if(l.length<=0){return true}o[r]=l});if(yunj.isEmptyObj(o)){throw new Error("请勾选要上传的数据")}}else{o=[];let e=l.eq(0);let t=e.attr("id");let r=a.layTable.checkStatus(t).data;if(r.length>0){o=r}if(o.length<=0){throw new Error("请勾选要上传的数据")}}return o}setEventBind(){let t=this;t.contentBoxEl.on("DOMNodeInserted",".type-tab-tables .tab-tables.error .error-cell",function(e){t.checkCellData(i(this));e.stopPropagation()})}}e("ImportStepTwo",a)});