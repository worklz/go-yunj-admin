layui.define(["jquery","yunj","ImportStepTypeTable"],function(t){let e=window;let l=document;let a=layui.jquery;let i=layui.ImportStepTypeTable;class s extends i{constructor(t){super(t,"three","导入数据");this.typeSort=["all","success","fail"];this.typeConfig={all:{desc:"所有数据",importBtnStatus:{wait:{desc:"开始导入"},importing:{desc:"正在导入..."},completed:{desc:"导入完成/关闭"},go_on:{desc:"继续导入"}}},success:{desc:"成功数据"},fail:{desc:"失败数据"}};this.itemImportStatus={wait:{code:"wait",desc:"等待导入"},importing:{code:"importing",desc:"正在导入"},success:{code:"success",desc:"导入成功"},fail:{code:"fail",desc:"导入失败",error:{}}};this.currType="all";this.isImporting=false}async render(t=false){let e=this;if(!t){return}e.initData();e.setContentBoxHtml();e.handleItems();e.setCurrType("all");e.setImportProgress()}setCurrType(t){let e=this;super.setCurrType(t,()=>{if(t==="fail"){e.setTypeTabTablesCheckCount(t)}})}initData(){let t=this;super.initData();t.isImporting=true}handleItems(){let e=this;let l=e.getCheckedImportItems();if(yunj.isObj(l)){for(let t in l){if(!l.hasOwnProperty(t)){continue}l[t].forEach(t=>{t._importStatus=e.itemImportStatus.wait;e.addAllItem(t)})}}else{l.forEach(t=>{t._importStatus=e.itemImportStatus.wait;e.addAllItem(t)})}e.renderTypeCount("all")}addAllItem(t){let e=this;e.addTypeItem("all",t)}addSuccessItem(t){let e=this;e.addTypeItem("success",t)}addFailItem(t){let e=this;e.addTypeItem("fail",t)}delFailItem(t){let e=this;e.delTypeItem("fail",t)}checkItemIsCanImport(t){return t&&yunj.isObj(t)&&t.hasOwnProperty("_importStatus")&&t._importStatus.code==="wait"}getAllItemsCount(t=false){let e=this;return e.getTypeItemsCount("all",t)}getSuccessItemsCount(){let t=this;return t.getTypeItemsCount("success")}getFailItemsCount(){let t=this;return t.getTypeItemsCount("fail")}renderAllActionHtml(){let i=this;let t=i.getCurrTypeActionFormId();i.typeActionEl.append(`<div class="action all">
                                            <div class="tips">已上传<em class="import-rate"></em></div>
                                            <form class="layui-form layui-form-pane" lay-filter="${t}">
                                                <div class="layui-form-item" style="margin: 0">
                                                    <button type="button" class="layui-btn layui-btn-sm btn-import" data-status="wait">
                                                        ${i.typeConfig.all.importBtnStatus.wait.desc}
                                                    </button>
                                                </div>
                                            </form>
                                        </div>`);i.typeActionEl.on("click",".all .layui-form .btn-import",function(t){let e=a(this);let l=e.data("status");if(l==="importing"){yunj.msg("数据正在导入中...")}else if(l==="completed"){yunj.confirm("数据导入完成，确认退出？",function(){yunj.closeCurr()})}else if(l==="wait"||l==="go_on"){if(i.getAllItemsCount()<=0){yunj.msg("暂无可导入数据")}else{yunj.confirm("确认导入？",function(){i.importHandle().then(()=>{yunj.msg("数据导入完成");if(i.getSuccessItemsCount()>0){let t=yunj.rawTable();t&&t.render()}}).catch(t=>{console.log(t);yunj.error(t)})})}}t.stopPropagation()})}renderFailActionHtml(){let e=this;let t=e.getCurrTypeActionFormId();let l=e.getTypeCheckAllFilter("fail");e.typeActionEl.append(`<div class="action fail">
                                            <div class="tips">选中<em class="check-count">0</em>条</div>
                                            <form class="layui-form layui-form-pane" lay-filter="${t}">
                                                <div class="layui-form-item" style="margin: 0">
                                                    <input type="checkbox" title="全选" lay-filter="${l}">
                                                    <button type="button" class="layui-btn layui-btn-sm btn-check-submit">验证/提交至所有</button>
                                                </div>
                                            </form>
                                        </div>`);e.actionNoticeEl.html("注意：可对失败数据修改后点击【验证/提交至所有】按钮重新导入数据！");e.layForm.render("checkbox",t);e.layForm.on(`checkbox(${l})`,function(t){e.setCurrTypeTabTablesCheckAll(t.elem.checked)});e.typeActionEl.find(`.action.fail input[type=checkbox][lay-filter='${l}']`).prop("checked",true);e.layForm.render("checkbox",t);e.contentBoxEl.on("click",".type-action .action.fail .btn-check-submit",function(t){e.failItemsCheckSubmit();t.stopPropagation()})}failItemsCheckSubmit(){let l=this;super.typeTabTableItemsCheckSubmit("fail",t=>{t._importStatus=l.itemImportStatus.wait;l.delFailItem(t);l.addAllItem(t)},(t,e)=>{t._importStatus=l.itemImportStatus.fail;t._importStatus.desc=e.getError();t._importStatus.error=e.getFieldError();l.changeItem(t)},(t,e)=>{if(t){l.reloadTypeHtml("fail");l.setTypeTabTablesCheckCount("fail");l.reloadTypeHtml("all");l.setImportProgress();l.setAllActionImportBtnStatus("go_on")}if(e){yunj.msg(`仍有${e}条数据错误，请修改后重新提交`)}})}failCellCheck(t){let e=this;super.checkCellData(t,(t,e,l)=>{t._importStatus.error[e]=l.getError()})}setAllActionImportBtnStatus(t){let e=this;let l=e.typeConfig.all.importBtnStatus[t];e.typeActionEl.find(".all .layui-form .btn-import").data("status",t).html(l.desc)}getTypeTabTableTabTitleAppendHtml(t,e){let l=this;if(t==="all"){let t=l.getAllItemsCount(e);return`<span class="layui-badge count wait layui-bg-cyan" title="${t}条数据等待导入" >${t}</span>
                        <span class="layui-badge count importing layui-bg-blue" title="暂无导入中数据">0</span>
                        <span class="layui-badge count success layui-bg-green" title="暂无导入成功数据">0</span>
                        <span class="layui-badge count fail" title="暂无导入失败数据">0</span>
                            <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop"></i>`}return`<span class="layui-badge count ${t==="success"?"layui-bg-green":""}">${l.getTypeItemsCount(t,e)}</span>`}getTypeTabTableCols(e,t=false){let l=this;let i=l.getCols(t);let a=[];if(e==="fail"){a.push({field:"_id",type:"checkbox",LAY_CHECKED:true})}if(e==="all"||e==="fail"){a.push({field:"_importStatus",title:"导入状态",templet:function(t){return`<div class="import-status-cell ${t._importStatus.code}" id="import_status_${e}_cell_${t._id}" title="${t._importStatus.desc}">${t._importStatus.desc}</div>`}})}for(let l in i){if(!i.hasOwnProperty(l)){continue}let t={field:l,type:"normal",title:i[l].title};if(e==="fail"){t.edit="text";t.templet=function(e){if(e._importStatus.hasOwnProperty("error")&&yunj.isObj(e._importStatus.error)&&e._importStatus.error.hasOwnProperty(l)){let t=e._importStatus.error[l];return`<div class="fail-cell" title="${t}" data-field="${l}" data-row-data='${JSON.stringify(e)}'>${e[l]}</div>`}return e[l]}}a.push(t)}return a}renderTypeTabTableDone(l,i,a){let s=this;s.layTable.resize(l.id);if(i==="fail"){s.setTypeTabTablesCheckCount(i);s.layTable.on(`checkbox(${l.id})`,function(t){if(t.type==="all"){s.setItemsChecked(t.checked,i,a)}else{s.setItemChecked(t.checked,i,t.data)}s.setTypeTabTablesCheckCount(i)});let t=s.typeTabTablesEl.find(`.layui-table-view[lay-id=${this.id}] .layui-table-header thead:first tr:first th:first .layui-form-checkbox`);let e=t.hasClass("layui-form-checked");if(e){t.click()}}}changeItemImportStatus(t,e=false){let l=this;if(e){t._importStatus=e}l.changeItem(t);let i=l.typeTabTablesEl.find(`.tab-tables.all #import_status_all_cell_${t._id}`);if(i.length>0){e=t._importStatus;i.attr("class",`import-status-cell ${e.code}`).attr("title",e.desc).html(e.desc)}}setImportTabTableTitleLoading(t){let e=this;let l=e.typeTabTablesEl.find(`.tab-tables.all .layui-tab-title`);if(l.length<=0){return}let i=l.find("li .layui-icon-loading");if(i.length>0){i.removeClass("importing")}if(!t||t.length<=0){return}t.forEach(t=>{let e=l.find(`li.${t} .layui-icon-loading`);if(e.length>0){e.addClass("importing")}})}setImportProgress(){let r=this;let a=0;let o={};for(let i in r.typeAllItems){if(!r.typeAllItems.hasOwnProperty(i)){continue}let t=r.typeAllItems[i];let e=t._sheet;let l=t._importStatus;if(!o.hasOwnProperty(e)){o[e]={wait:0,importing:0,success:0,fail:0}}o[e][l.code]++;if(l.code==="success"||l.code==="fail"){a++}}if(!yunj.isEmptyObj(o)){for(let s in o){if(!o.hasOwnProperty(s)){continue}for(let a in o[s]){if(!o[s].hasOwnProperty(a)){continue}let i=r.typeTabTablesEl.find(`.tab-tables.all .layui-tab-title li.${s} .count.${a}`);if(i.length>0){let t=o[s][a];let e=r.itemImportStatus[a].desc;let l=t>0?`${e}：${t}`:`暂无${e}的数据`;i.attr("title",l).html(t)}}}}let t=r.getAllItemsCount();r.typeActionEl.find(`.action.all .import-rate`).html(a+"/"+t);return a===t}async importHandle(){let e=this;e.importStart();let l=[];let i=e.getTypeItemIds("all");if(yunj.isObj(i)){for(let t in i){if(i.hasOwnProperty(t)&&yunj.isArray(i[t])){l.push(...i[t])}}}else if(yunj.isArray(i)){l=i}if(l.length<=0){e.importEnd();return}let a={itemIds:l,startIdx:0,maxIdx:l.length-1,limit:e.importObj.rawArgs.limit};while(true){let t=await e.importExec(a);if(t===true){break}}e.importEnd()}importExec(a){let r=this;return new Promise(s=>{if(!r.isImporting){s(true);return}let l=[];let i=[];while(l.length<a.limit&&a.startIdx<=a.maxIdx){let e=a.itemIds[a.startIdx];if(r.typeAllItems.hasOwnProperty(e)){let t=r.typeAllItems[e];if(r.checkItemIsCanImport(t)){r.changeItemImportStatus(t,r.itemImportStatus.importing);l.push(t);if(t._sheet){i.push(t._sheet)}}}a.startIdx++}if(l.length<=0){s(true);return}r.setImportTabTableTitleLoading(i);r.setImportProgress();let t={[yunj.config("builder.id_key")]:r.importId,[yunj.config("builder.async_type_key")]:"import",items:JSON.stringify(l)};yunj.request(yunj.url(true),t,"post").then(t=>{let e=t.data.items;let i=false;let a=false;e.forEach(t=>{let e=t._id;let l=t._importStatus;if(r.typeAllItems.hasOwnProperty(e)){let t=r.typeAllItems[e];t._importStatus=l;r.changeItemImportStatus(t);if(l.code==="success"){r.addSuccessItem(t);i=true}else if(l.code==="fail"){r.addFailItem(t);a=true}}});i&&r.reloadTypeHtml("success");a&&r.reloadTypeHtml("fail");r.setTypeTabTablesActive();let l=r.setImportProgress();if(l){r.setImportTabTableTitleLoading()}s(l)}).catch(t=>{throw t})})}importStart(){let t=this;t.isImporting=true;t.setAllActionImportBtnStatus("importing")}importEnd(){let t=this;this.isImporting=false;t.setAllActionImportBtnStatus("completed");t.importStepBoxEl.children(".item.curr").removeClass("curr").addClass("finish")}setEventBind(){let e=this;e.contentBoxEl.on("DOMNodeInserted",".type-tab-tables .tab-tables.fail .fail-cell",function(t){e.failCellCheck(a(this));t.stopPropagation()})}}t("ImportStepThree",s)});