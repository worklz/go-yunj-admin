layui.define(["jquery","yunj","ImportStep","upload"],function(e){let t=window;let l=document;let s=layui.jquery;let o=layui.ImportStep;let i=layui.upload;class n extends o{constructor(e){super(e,"one","上传文件");this.templetDescSheetName="导入数据描述";this.templetDescSheet=null;this.templetBlob=null;this.uploadFile=null;this.layUploadObj=null}async render(e=false){let t=this;if(!e&&t.contentBoxEl.html().length>0)return;let l="";t.importObj.rawArgs.tips.forEach((e,t)=>l+=`<li>${t+1}、${e}</li>`);let s=`<div class="yunj-import-step-content-row">
                                <button class="layui-btn layui-btn-sm layui-btn-normal yunj-btn-templet-download" >
                                    <i class="layui-icon layui-icon-download-circle"></i>
                                    点击下载示例模板
                                </button>
                            </div>
                            <div class="yunj-import-step-content-row file-upload-box" style="position: relative">
                                <div class="file-drag">
                                    <i class="layui-icon layui-icon-upload"></i>
                                    <p>点击上传，或将文件拖拽到此处</p>
                                </div>
                                <div class="file-preview">
                                    <div class="item"><span class="name">qwe</span>
                                    <i class="layui-icon layui-icon-close-fill remove" title="删除文件：qwe"></i></div>
                                </div>
                            </div>
                            <div class="yunj-import-step-content-row tips-box">
                                <span class="title">提示！请注意以下问题：</span>
                                <ul class="list">${l}</ul>
                            </div>`;t.contentBoxEl.html(s);t._uploadEventBind()}_initTempletDescSheet(){let e=this;let t={sheet:{},range:{s:{c:0,r:0},e:{c:0,r:0}},merges:[{s:{c:0,r:0},e:{c:1,r:0}}],cols:[{wch:10},{wch:100}],rowIdx:0};let l={v:"注意：黄色底纹列为必填项",s:{font:{name:"宋体",sz:9,color:{rgb:"FFFF0000"}},alignment:{vertical:"center"}}};let s=XLSX.utils.encode_cell({c:0,r:0});t.sheet[s]=l;e.templetDescSheet=t}_getTempletDescSheetNewRow(e=1){return this.templetDescSheet.rowIdx=this.templetDescSheet.rowIdx+e}_setTempletDescSheetCol0Wch(e){let t=this;let l=t.templetDescSheet.cols[0]["wch"];if(e>l)t.templetDescSheet.cols[0]["wch"]=e}_setTempletDescSheetCell(t){let l=this;t=yunj.objSupp(t,{col:0,row:l.templetDescSheet.rowIdx,cell:null,mergeA1A2:false});if(t.cell){let e=XLSX.utils.encode_cell({c:t.col,r:t.row});l.templetDescSheet.sheet[e]=t.cell}if(t.mergeA1A2)l.templetDescSheet.merges.push({s:{c:0,r:t.row},e:{c:1,r:t.row}})}_setTempletSheet(e,t,h){let d=this;d._setTempletDescSheetCell({row:d._getTempletDescSheetNewRow(),mergeA1A2:true});d._setTempletDescSheetCell({row:d._getTempletDescSheetNewRow(),mergeA1A2:true,cell:{v:`${t}工作表字段描述如下：`,s:{font:{name:"宋体",sz:9},alignment:{vertical:"center"}}}});let l={s:{c:0,r:0},e:{c:0,r:0}};let f={};let y=[];let S=0;for(let u in h){if(!h.hasOwnProperty(u))continue;let e=h[u];let t=e["title"];let l=e["default"];let s=e["verify"].length>0?e["verify"].split("|"):[];let o=e["desc"];let i=yunj.xlsx_sheet_cell_wch(t);let n=yunj.xlsx_sheet_cell_wch(l);if(o.length>0){d._setTempletDescSheetCell({row:d._getTempletDescSheetNewRow(),cell:{v:t,s:{font:{name:"宋体",sz:9},alignment:{vertical:"center",horizontal:"center"}}}});d._setTempletDescSheetCell({col:1,cell:{v:o,s:{font:{name:"宋体",sz:9},alignment:{vertical:"center",wrapText:true}}}});d._setTempletDescSheetCol0Wch(i)}let c={v:t,t:"s",s:{fill:{fgColor:{rgb:s.indexOf("require")!==-1?"FFFFFF00":"FFC0C0C0"}},font:{name:"宋体",sz:11},alignment:{vertical:"center",horizontal:"center"},border:{right:{style:"thin"},bottom:{style:"thin"}}}};let r=XLSX.utils.encode_cell({c:S,r:0});let a={v:l,t:yunj.isNumber(l)?"n":yunj.isBool(l)?"b":"s",s:{font:{name:"宋体",sz:11},alignment:{vertical:"center"}}};let p=XLSX.utils.encode_cell({c:S,r:1});let m=i>n?i:n;m=m>10?m:10;y.push({wch:m});f[r]=c;f[p]=a;S++}l.e.c=S;l.e.r=1;f["!ref"]=XLSX.utils.encode_range(l);f["!cols"]=y;e.SheetNames.push(t);e.Sheets[t]=f}_setTempletBlob(){let l=this;let s={SheetNames:[],Sheets:{}};l._initTempletDescSheet();let o=l.getCols();if(l.isSetSheet()){l.importObj.rawArgs.sheet.forEach(e=>{if(!o.hasOwnProperty(e))return;let t=o[e];l._setTempletSheet(s,e,t)})}else{l._setTempletSheet(s,l.importObj.defaultSheetName,o)}let e=l.templetDescSheet;e.range.e.c=1;e.range.e.r=e.rowIdx;e.sheet["!ref"]=XLSX.utils.encode_range(e.range);e.sheet["!cols"]=e.cols;e.sheet["!merges"]=e.merges;s.SheetNames.push(l.templetDescSheetName);s.Sheets[l.templetDescSheetName]=e.sheet;let t={bookType:"xlsx",bookSST:false,type:"binary"};let i=XlsxStyle.write(s,t);l.templetBlob=new Blob([yunj.str_to_array_buffer(i)],{type:"application/octet-stream"})}_getTempletBlob(){let e=this;if(!e.templetBlob)e._setTempletBlob();return e.templetBlob}_templetDownload(){let e=this;let t=`${e.importId}模板.xlsx`;if(e.isSetTemplet()){yunj.download(e.importObj.rawArgs.templet,t);return}if(!e.isSetCols()){yunj.alert(`导入[${e.importId}]未设置[cols]`);return}yunj.download({name:t,blob:e._getTempletBlob()})}_setUploadFile(e=null){let t=this;let l=t.contentBoxEl.find(".file-upload-box .file-preview");if(e){l.html(`<div class="item"><span class="name">${e.name}</span><i class="layui-icon layui-icon-close-fill remove" title="删除文件：${e.name}"></i></div>`).css("display","flex");t.uploadFile=e}else{l.hide();t.uploadFile=null;t.layUploadObj&&t.layUploadObj.reload()}}_uploadEventBind(){let s=this;s.layUploadObj=i.render({elem:`#yunj_import_${s.importId} .file-upload-box .file-drag`,accept:"file",auto:false,choose:function(e){if(!s.isSetCols()){yunj.alert(`导入[${s.importId}]未设置[cols]`);return}e.pushFile();e.preview(function(e,t,l){if(!yunj.isCsv(t)&&!yunj.isXlsx(t)&&!yunj.isXls(t)){yunj.msg("上传文件格式需为：xlsx/xls/csv");return false}s._setUploadFile(t)});s.layUploadObj.config.elem.next()[0].value=""}})}setEventBind(){let t=this;t.contentBoxEl.on("click",".yunj-btn-templet-download",function(e){t._templetDownload();e.stopPropagation()});t.contentBoxEl.on("click",".file-upload-box .remove",function(e){t._setUploadFile();e.stopPropagation()})}}e("ImportStepOne",n)});