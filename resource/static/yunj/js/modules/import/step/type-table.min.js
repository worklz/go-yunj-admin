layui.define(["jquery","table","form","yunj","validate","ImportStep"],function(t){let e=window;let l=document;let o=layui.jquery;let i=layui.ImportStep;let p=layui.validate;class a extends i{constructor(t,e="",l=""){super(t,e,l);this.layTable=layui.table;this.layForm=layui.form;this.colsValidateAttr={};this.typesEl;this.typeActionEl;this.typeTabTablesEl;this.actionNoticeEl;this.typeSort=[];this.typeConfig={};this.typeAllItems={};this.currType}initData(){let t=this;t.typeAllItems={};let e=t.typeConfig;for(let t in e){if(e.hasOwnProperty(t)&&yunj.isObj(e[t])&&e[t].hasOwnProperty("itemIds")){delete e[t].itemIds}}t.contentBoxEl.html("")}setContentBoxHtml(){let t=this;t.contentBoxEl.html(`<div class="yunj-import-step-content-row action-box">
                                        <div class="types"></div>
                                        <div class="type-action"></div>
                                    </div>
                                    <div class="yunj-import-step-content-row action-box action-notice"></div>
                                    <div class="yunj-import-step-content-row action-box type-tab-tables"></div>`);t.typesEl=t.contentBoxEl.find(".types");t.typeActionEl=t.contentBoxEl.find(".type-action");t.typeTabTablesEl=t.contentBoxEl.find(".type-tab-tables");t.actionNoticeEl=t.contentBoxEl.find(".action-notice");t.setTypesHtml()}setTypesHtml(){let s=this;let n=s.typeSort;let r="";for(let a=0;a<n.length;a++){if(a!==0){r+=`<span class="split">|</span>`}let t=n[a];let e=s.typeConfig[t];let l=0;let i=`get${yunj.ucfirst(t)}ItemsCount`;if(typeof s[i]==="function"){l=s[i]()}r+=`<a href="javascript:void(0);" class="${t}" data-type="${t}">${e.desc} <span class="count">${l}</span></a>`}s.typesEl.html(r);s.contentBoxEl.on("click",".types a",function(t){s.setCurrType(o(this).data("type"));t.stopPropagation()})}setCurrType(t,e){let l=this;l.setTypeActive(t);l.setCurrTypeActionHtml();l.setTypeTabTablesHtml();l.setTypeTabTablesActive();e&&e()}setTypeActive(t){let e=this;e.currType=t;e.typesEl.find("a").removeClass("active");e.typesEl.find(`a.${t}`).addClass("active")}getCurrTypeActionFormId(){let t=this;return`yunj_import_${this.importId}_step_${t.name}_${t.currType}_form_action`}setCurrTypeActionHtml(){let e=this;let l=e.currType;if(e.typeActionEl.find(`.action.${l}`).length<=0){let t="render"+yunj.ucfirst(l)+"ActionHtml";if(typeof e[t]==="function"){e[t]()}}let t=e.typeActionEl.find(".action");if(t.length>0){t.removeClass("active")}let i=e.typeActionEl.find(`.action.${l}`);if(i.length>0){i.addClass("active")}}setCurrTypeTabTablesCheckAll(i){let t=this;t.typeTabTablesEl.find(`.tab-tables.${t.currType} .layui-tab-content .layui-tab-item`).each(function(t){let e=o(this).find(".layui-table-header thead:first tr:first th:first .layui-form-checkbox");let l=e.hasClass("layui-form-checked");if(i){if(l){return true}}else{if(!l){return true}}e.click()})}setTypeTabTablesHtml(n){let r=this;if(!n){n=r.currType}if(r.typeTabTablesEl.find(`.tab-tables.${n}`).length){return}let y=r.getTypeItemIds(n);if(y.length<=0){return}r.typeTabTablesEl.append(`<div class="layui-tab tab-tables ${n}"></div>`);let e=r.typeTabTablesEl.find(`.tab-tables.${n}`);let t=`<ul class="layui-tab-title"></ul>`;let l=`<div class="layui-tab-content"></div>`;if(yunj.isObj(y)){e.html(t+l);let i=e.find(".layui-tab-title");let a=e.find(".layui-tab-content");let s=0;for(let l in y){if(!y.hasOwnProperty(l)){continue}let t=y[l];if(t.length<=0){continue}let e=r.getTypeTabTableTabTitleAppendHtml(n,l);i.append(`<li class="${l} ${s===0?"layui-this":""}">${l}${e}</li>`);a.append(r.getTypeTabTableLayout(s===0,n,l));r.renderTypeTabTable(n,l);s++}}else{if(y.length<=0){return}e.html(l);let t=e.find(".layui-tab-content");t.append(r.getTypeTabTableLayout(true,n));r.renderTypeTabTable(n)}}getTypeTabTableTabTitleAppendHtml(t,e){let l=this;return""}setTypeTabTablesActive(t){let e=this;if(!t){t=e.currType}let l=e.typeTabTablesEl.find(".tab-tables");if(l.length>0){l.removeClass("active")}let i=e.typeTabTablesEl.find(`.tab-tables.${t}`);if(i.length>0){i.addClass("active")}}reloadTypeHtml(t){let e=this;e.typesEl.find(`a.${t} .count`).html(e.getTypeItemsCount(t));let l=e.typeTabTablesEl.find(`.tab-tables.${t}`);if(l.length){l.remove()}e.setTypeTabTablesHtml(t)}delTypeTabTableHtml(t,l=false){let e=this;let i=e.typeTabTablesEl.find(`.tab-tables.${t}`);if(i.length<=0){return}if(l){let t=i.find(`.layui-tab-title > li.${l}`);t.length>0&&t.remove();let e=i.find(`.layui-tab-content > .layui-tab-item.${l}`);e.length>0&&e.remove();if(i.find(`.layui-tab-title > li.layui-this`).length<=0){i.find(`.layui-tab-title > li`).removeClass("layui-this");i.find(`.layui-tab-content > .layui-tab-item`).removeClass("layui-this");let t=i.find(`.layui-tab-title > li:first`);t.length>0&&t.addClass("layui-this");let e=i.find(`.layui-tab-content > .layui-tab-item:first`);e.length>0&&e.addClass("layui-show")}}else{i.html("")}}getTypeTabTableId(t,e=false){let l=this;return`yunj_import_${this.importId}_step_${l.name}_${t}_table${e?`_${e}`:""}`}getTypeTabTableLayout(t,e,l=false){let i=this;let a=this.getTypeTabTableId(e,l);let s="layui-tab-item";if(l){s+=" "+l}if(t){s+=" layui-show"}return`<div class="${s}">
                        <table class="layui-table" id="${a}" lay-filter="${a}" data-sheet="${l}"></table>
                    </div>`}renderTypeTabTable(l,i=false){let a=this;let t=a.getTypeTabTableId(l,i);let e={elem:`#${t}`,url:"/"+YUNJ_ADMIN_ENTRANCE+"/empty",method:"post",contentType:"application/json",parseData:function(t){let e=a.getTypeItems(l,i);return{code:0,msg:"success",count:0,data:e}},page:false,loading:true,text:{none:"暂无相关数据"},cols:[a.getTypeTabTableCols(l,i)],done:function(t){a.renderTypeTabTableDone(this,l,i)}};a.layTable.render(e)}getTypeTabTableCols(t,e=false){return[]}renderTypeTabTableDone(t,e,l=false){let i=this;i.layTable.resize(t.id)}setTypeTabTablesCheckCount(a){let s=this;let n=0;if(!a){a=s.currType}s.typeTabTablesEl.find(`.tab-tables.${a} .layui-tab-item > .layui-table`).each(function(){let t=o(this);let e=t.attr("id");let l=s.layTable.checkStatus(e).data.length;let i=t.data("sheet");if(i){s.typeTabTablesEl.find(`.tab-tables.${a} .layui-tab-title li.${i} .check-count`).html(l)}n+=l});s.typeActionEl.find(`.action.${a} .check-count`).html(n);s.typeActionEl.find(`.action.${a} input[type=checkbox][lay-filter='${s.getTypeCheckAllFilter(a)}']`).prop("checked",n&&n===s.getTypeItemsCount());s.layForm.render("checkbox",s.getCurrTypeActionFormId())}getTypeCheckAllFilter(t){let e=this;return`yunj_import_${this.importId}_step_${e.name}_${t}_check_all}`}setItemsChecked(e,t,l=false){let i=this;let a=i.getTypeItemIds(t,l);if(yunj.isObj(a)){let t=l?[l]:Object.keys(items);t.forEach(t=>{a[t].forEach(t=>{if(i.typeAllItems.hasOwnProperty(t)){i.typeAllItems[t].LAY_CHECKED=!!e}})})}else if(yunj.isArray(a)){a.forEach(t=>{if(i.typeAllItems.hasOwnProperty(t)){i.typeAllItems[t].LAY_CHECKED=!!e}})}}setItemChecked(t,e,l){let i=this;l.LAY_CHECKED=!!t;i.changeItem(e,l)}getColsValidateAttr(t=false){let e=this;let l=e.colsValidateAttr;if(!yunj.isEmptyObj(l)){if(t===false){return l}else{if(l.hasOwnProperty(t)){return l[t]}}}let i={rule:{},dataTitle:{}};let a=e.getCols(t);for(let e in a){if(!a.hasOwnProperty(e)){continue}let t=a[e];if(t.verify.length<=0){continue}i.rule[e]=t.verify;i.dataTitle[e]=t.title}t===false?l=i:l[t]=i;e.colsValidateAttr=l;return i}addTypeItem(t,e){let l=this;let i=e._id;let a=l.typeAllItems;if(!a.hasOwnProperty(i)){a[i]=e}let s=l.typeConfig[t];let n=e._sheet;if(n){if(!s.hasOwnProperty("itemIds")||!yunj.isObj(s.itemIds)){s.itemIds={}}let t=s.itemIds;if(!t.hasOwnProperty(n)||!yunj.isArray(t[n])){t[n]=[]}if(t[n].indexOf(i)===-1){t[n].push(i)}}else{if(!s.hasOwnProperty("itemIds")||!yunj.isArray(s.itemIds)){s.itemIds=[]}if(s.itemIds.indexOf(i)===-1){s.itemIds.push(i)}}l.renderTypeCount(t)}delTypeItem(t,e){let l=this;let i=e._id;let a=l.typeAllItems;if(a.hasOwnProperty(i)){delete a[i]}let s=e._sheet;let n=l.getTypeItemIds(t,s);let r=n.indexOf(i);if(r===-1){return}n.splice(r,1);if(s){l.typeConfig[t].itemIds[s]=n}else{l.typeConfig[t].itemIds=n}l.renderTypeCount(t)}changeItem(t){let e=this;let l=t._id;let i=e.typeAllItems;if(i.hasOwnProperty(l)){i[l]=Object.assign({},i[l],t)}}renderTypeCount(e){let l=this;let i=l.typesEl.find(`a.${e} .count`);if(i.length){let t="get"+yunj.ucfirst(e)+"ItemsCount";i.html(l[t]())}}getTypeItems(t,e=false){let l=this;let i=[];let a=l.getTypeItemIds(t,e);a.forEach(t=>{if(l.typeAllItems.hasOwnProperty(t)){i.push(l.typeAllItems[t])}});return i}getTypeItemIds(t,e=false){let l=this;let i=[];if(!l.typeConfig[t].hasOwnProperty("itemIds")){return i}if(e){if(yunj.isObj(l.typeConfig[t].itemIds)&&l.typeConfig[t].itemIds.hasOwnProperty(e)){i=l.typeConfig[t].itemIds[e]}}else{i=l.typeConfig[t].itemIds}return i}getTypeItemsCount(t,e=false){let l=this;let i=0;if(!t){t=l.currType}let a=l.getTypeItemIds(t,e);if(yunj.isObj(a)){for(let t in a){if(a.hasOwnProperty(t)&&yunj.isArray(a[t])){i+=a[t].length}}}else if(yunj.isArray(a)){i=a.length}return i}typeTabTableItemsCheckSubmit(t,i,a,e){let s=this;let l=s.typeTabTablesEl.find(`.tab-tables.${t} .layui-tab-item > .layui-table`);if(l.length<=0){yunj.msg("暂无可选错误数据");return}let n=[];l.each(function(){let t=o(this).attr("id");let e=s.layTable.checkStatus(t).data;if(e.length<=0){return true}n.push(...e)});if(n.length<=0){yunj.msg("请选择要验证提交的数据");return}let r=0;let y=0;n.forEach(t=>{let e=s.getColsValidateAttr(t._sheet);p.create({rule:e.rule});let l=p.check(t,e.dataTitle);if(!l){a&&a(t,p);r++}else{i&&i(t);y++}});e&&e(y,r);s.setTypeTabTablesActive(t)}checkCellData(a,s){let t=this;let n=a.data("rowData");let r=a.data("field");let y=a.html();let o=t.getColsValidateAttr(n._sheet);if(o.rule.hasOwnProperty(r)){let t={};t[r]=o.rule[r];let e={};e[r]=o.dataTitle[r];let l={};l[r]=y;p.create({rule:t,batch:true});let i=p.check(l,e);if(!i){s&&s(n,r,p);a.attr("title",error)}else{a.css({background:"#fff",color:"#189f92"});a.attr("title","")}}n[r]=y;a.data("rowData",n)}}t("ImportStepTypeTable",a)});