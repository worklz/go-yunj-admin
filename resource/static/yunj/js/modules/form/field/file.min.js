layui.define(["FormField","yunj","upload"],function(e){let i=layui.FormField;let l=window;let o=document;let s=layui.jquery;let t=layui.upload;class n extends i{constructor(e={}){super(e);this.previewBoxEl=null;this.chooseFiles={};this.triggerUploadSelector=`#${this.id} .upload-trigger`;this.sortable=null;this.uploadActionFilter=`#${this.id} .files-upload-box .upload-action-elem`;this.filesPreviewBoxEl=null;this.uploadFiles={};this.uploadProgressData={};this.uploadProgressTimer={}}defineExtraArgs(){let e=this;return{multi:false,size:yunj.config("file.upload_file_size"),ext:yunj.config("file.upload_file_ext"),text:"文件上传"}}handleArgs(e){if(this.isMulti(e.multi)){if(e.verify.indexOf("urls")===-1)e.verify+=(e.verify?"|":"")+"urls"}else{if(e.verify.indexOf("url")===-1)e.verify+=(e.verify?"|":"")+"url"}return e}layoutControl(){let e=this;let i=`<div class="file-box ${e.isMulti()?"multi":""}">
                                    <div class="preview-box"></div>
                                    <div class="select-box ${e.isReadonly()?"readonly":""}" title="${e.isReadonly()?"禁用":"选择文件上传"}">
                                        <i class="layui-icon layui-icon-upload upload-icon"></i>
                                        <span>${e.args.text}</span>
                                        <span class="limit-count-desc"></span>
                                    </div>
                                    <i class="upload-trigger"></i>
                                </div>`;return`<div class="layui-input-inline yunj-form-item-control">${i}</div>`}descContent(){let e=this;let i=e.args.desc;if(!i){i=`允许上传大小不超过 ${e.args.size}MB 且格式为 ${e.args.ext.replace(/,/g,"/")} 的文件。`;if(e.isMulti()){i+=`允许最大上传数 ${e.getMultiLimitCount()}。`}}return i}async renderDone(){let t=this;t.previewBoxEl=t.boxEl.find(".preview-box");if(t.isMulti()&&!t.isReadonly()){await yunj.includeJs("/static/yunj/libs/Sortable/Sortable.min.js");let i=`${t.id}_event_bind_sort`;if(yunj.isUndefined(l[i])){l[i]=true;let e={handle:`.preview-box>.item`,animation:150,ghostClass:"sort-checked"};t.sortable=new Sortable(o.querySelector(`#${t.id} .preview-box`),e)}}return"done"}setValue(e=""){let t=this;let i=e;if(yunj.isString(i)&&i.length>0)i=yunj.isJson(i)?JSON.parse(i):i.indexOf(",")!==-1?i.split(","):[i];if(!yunj.isArray(i))i=[];t.previewBoxEl.hide();t.getPreviewItemHtml(i).then(e=>{t.setPreviewBoxHtml(e);let i=e.length>0&&t.isReadonly()?"none":"flex";t.boxEl.find(".select-box").css("display",i)})}getValue(){let e=this;let t=[];e.previewBoxEl.find(".item").each(function(){let e=s(this).find(".item-download");if(e.length<=0){return true}let i=e.data("url");if(!i||!yunj.isString(i)||i.length>2e3){return true}t.push(yunj.urlAppendDomain(i))});return t.length>0?e.isMulti()?t:t[0]:""}setMultiLimitCountDesc(){let e=this;if(!e.isMulti()){return}let i=e.previewBoxEl.children(".item").length+"/"+e.getMultiLimitCount();e.boxEl.find(".select-box .limit-count-desc").html(i).show()}setPreviewBoxHtml(e){let i=this;i.previewBoxEl.html(e).show();i.setMultiLimitCountDesc()}appendPreviewBoxHtml(e){let i=this;i.previewBoxEl.append(e).show();i.setMultiLimitCountDesc()}async getPreviewItemHtml(s){let n=this;let a="";for(let o=0,e=s.length;o<e;o++){let i=s[o];let t,l,e;if(yunj.isObj(i)){l=i.name;e=i.index;a+=`<div class="item" data-index="${e}">
                                    <input type="text" class="layui-input item-input" value="${l}" placeholder="文件名称" readonly>
                                    <span class="item-action-box">
                                        <i class="item-action item-upload-progress">0%</i>
                                        <i class="layui-icon layui-icon-close item-action item-upload-cancel" title="取消"></i>
                                    </span>
                                </div>`}else{t=i;l=yunj.urlFileName(t);let e=`<i class="layui-icon layui-icon-download-circle item-action item-download" title="下载:${l}" data-url="${t}"></i>`;if(!n.isReadonly()){e+=`<i class="layui-icon layui-icon-delete item-action item-delete" title="删除"></i>`}a+=`<div class="item">
                                    <input type="text" class="layui-input item-input" readonly value="${l}">
                                    <span class="item-action-box">${e}</span>
                                </div>`}}return a}async setChooseFilesPreview(){let t=this;let l=[];for(let i in t.chooseFiles){if(!t.chooseFiles.hasOwnProperty(i))continue;let e=t.chooseFiles[i];l.push({index:i,name:e.name})}let e=await t.getPreviewItemHtml(l);t.isMulti()?t.appendPreviewBoxHtml(e):t.setPreviewBoxHtml(e);for(let e in t.chooseFiles){if(!t.chooseFiles.hasOwnProperty(e))continue;t.setChooseFileUploadStart(e)}}setChooseFileUploadProgress(e,i={}){let t=this;let l={elem:null,rate_num:0};i=yunj.objSupp(i,l);let o=t.chooseFiles[e]||null;if(!o){return}if(!o.hasOwnProperty("uploadProgress")){o.uploadProgress=l}let s=o.uploadProgress;s.elem=s.elem||t.previewBoxEl.find(`.item[data-index=${e}]`);s.rate_num=i.rate_num;let n=i.rate_num+"%";s.elem.find(".item-upload-progress").html(n)}setChooseFileUploadStart(i){let t=this;t.setChooseFileUploadProgress(i,{rate_num:0});let l=t.chooseFiles[i].uploadProgress;l.timer=setInterval(function(){let e=l.rate_num;e=e+Math.random()*10|0;e=e>99?99:e;t.setChooseFileUploadProgress(i,{rate_num:e})},300+Math.random()*1e3)}setChooseFileUploadEnd(l,o){let s=this;let e=s.chooseFiles[l]||null;if(!e){return}let n=s.chooseFiles[l].uploadProgress;n.timer&&clearInterval(n.timer);s.setChooseFileUploadProgress(l,{rate_num:100});setTimeout(function(){let e=o;let i=yunj.urlFileName(e);n.elem.find(".item-input").val(i);let t=`<i class="layui-icon layui-icon-download-circle item-action item-download" title="下载:${i}" data-url="${e}"></i>
                                  <i class="layui-icon layui-icon-delete item-action item-delete" title="删除"></i>`;n.elem.find(".item-action-box").html(t);s.deleteChooseFileUploadData(l)},1e3)}setChooseFileUploadError(e,i=""){let t=this;let l=t.chooseFiles[e]||null;if(!l){return}let o=l.uploadProgress;let s=o.elem.find(".item-input").val();let n=`文件：${s} 上传异常！${i}`;let a=`<i class="layui-icon layui-icon-speaker item-action item-tips" title="${n}"></i>
                                  <i class="layui-icon layui-icon-delete item-action item-delete" title="删除"></i>`;o.elem.find(".item-action-box").html(a);t.deleteChooseFileUploadData(e)}deleteChooseFileUploadData(e){let i=this;let t=i.chooseFiles[e]||null;if(!t){return}let l=t.uploadProgress||null;if(l){l.timer&&clearInterval(l.timer)}delete i.chooseFiles[e]}layuiUploadRender(){let l=this;let e={elem:`#${l.id} .select-box`,url:yunj.fileUploadUrl("nameUnchanged"),accept:"file",exts:l.args.ext.replace(/,/g,"|"),auto:false,bindAction:l.triggerUploadSelector,field:"file",size:l.args.size*1024,multiple:l.isMulti(),drag:false,choose:function(e){if(!yunj.isEmptyObj(l.chooseFiles)){yunj.msg("待上传完成后，执行此操作");return false}l.chooseFiles=e.pushFile();if(l.isMulti()){let e=(l.previewBoxEl.find(".item").length|0)+(Object.keys(l.chooseFiles).length|0);let i=l.getMultiLimitCount();if(e>i){yunj.msg(`限制最大上传数 ${i}`);for(let e in l.chooseFiles){if(!l.chooseFiles.hasOwnProperty(e))continue;delete l.chooseFiles[e]}return false}}l.setChooseFilesPreview().then(e=>{s(l.triggerUploadSelector).click()})},done:function(e,i,t){if(e.errcode!==0){l.setChooseFileUploadError(i,e.msg);return false}l.setChooseFileUploadEnd(i,e.data)}};t.render(e)}defineExtraEventBind(){let l=this;if(l.isReadonly()){l.boxEl.on("click",".select-box",function(e){yunj.msg(`只读模式，禁止操作`);e.stopPropagation()})}else{l.layuiUploadRender();l.boxEl.on("click",".preview-box .item-delete,.item-upload-cancel",function(e){let i=s(this).parents(".item");let t=i.data("index");l.deleteChooseFileUploadData(t);i.remove();l.setMultiLimitCountDesc();e.stopPropagation()});l.boxEl.on("click",".preview-box .item-tips",function(e){let i=s(this).attr("title");yunj.error(i);e.stopPropagation()})}l.boxEl.on("click",".item-input",function(e){let i=s(this).val();yunj.copy(i)});l.boxEl.on("click",".preview-box .item-download",function(e){let i=s(this).data("url");if(!i||!yunj.isString(i)||i.length>2e3){return}yunj.download(i)})}isMulti(e=null){let i=this;if(e===null){if(yunj.isUndefined(i._multi)){i._multi=i.args.multi===true||yunj.isPositiveInt(i.args.multi)}return i._multi}return e===true||yunj.isPositiveInt(e)}getMultiLimitCount(){let e=this;e._multiLimitCount=e._multiLimitCount||(yunj.isPositiveInt(this.args.multi)?this.args.multi:9);return e._multiLimitCount}}e("FormFieldFile",n)});