layui.define(["FormField","yunj","jquery"],function(e){let t=layui.FormField;let r=window;let o=document;let i=layui.jquery;class l extends t{constructor(e={}){super(e);this.mode=null;this.markdownContainerId=null;this.markdown=null}defineExtraArgs(){let e=this;return{mode:"cherry",modeConfig:{cherry:{toolbar:["undo","redo","|","bold","italic","underline","strikethrough","color","size","|","header","list","hr","panel","|","image","link","code","table","|","togglePreview"],toolbarRight:["export","theme","copy"],mobileToolbar:["undo",{bold:["bold","italic","underline","strikethrough","color","size"]},"header",{insert:["list","hr","panel","image","link","code","table"]},"togglePreview"]},editormd:{height:250,watch:false,placeholder:"此处开始编写...",imageFormats:yunj.config("file.upload_img_ext").split(","),toolbar:["undo","redo","|","bold","del","italic","quote","|","h1","h2","h3","h4","|","list-ul","list-ol","hr","|","align-left","align-center","align-right","align-justify","|","table","datetime","html-entities","pagebreak","code","code-block","|","link","reference-link","image","video","|","watch","preview","clear","search","|","help"]}}}}handleArgs(e){let t=this;let r=e.mode;let o=e.modeConfig;let i=t.defineExtraArgs().modeConfig;if(!o.hasOwnProperty(r)){o[r]=i[r];e.modeConfig=o;return e}o[r]=Object.assign({},i[r],o[r]);if(r==="editormd"){o[r].toolbar=yunj.arrayIntersect(o[r].toolbar,i[r].toolbar)}e.modeConfig=o;return e}layoutControl(){let e=this;return e[`layout_control_${e.mode}`]()}async renderBefore(){let e=this;e.mode=e.args.mode;e.markdownContainerId=`${e.id}_markdown_${e.mode}`;await e[`render_before_${e.mode}`]();return"done"}async renderDone(){let e=this;await e[`render_done_${e.mode}`]();return"done"}setValue(e=""){let t=this;t[`set_value_${t.mode}`](e)}getValue(){let e=this;return e[`get_value_${e.mode}`]()}layout_control_cherry(){let e=this;return`<div class="layui-input-inline yunj-form-item-control cherry"><div id="${e.markdownContainerId}" style="width: 100%;height:100%;box-sizing: border-box"></div></div>`}async render_before_cherry(){let e=this;await yunj.includeCss("/static/yunj/libs/cherry-markdown/dist/cherry-markdown.min.css");await yunj.includeJs("/static/yunj/libs/cherry-markdown/dist/cherry-markdown.core.js");return"done"}async render_done_cherry(){let e=this;let t=e.get_options_cherry();e.markdown=new Cherry(t);return"done"}set_value_cherry(e=""){let t=this;t.markdown.setValue(e,true)}get_value_cherry(){let e=this;return e.markdown.getMarkdown()}get_options_cherry(){let e=this;let t={id:e.markdownContainerId,nameSpace:"cherry",themeSettings:{mainTheme:"light",codeBlockTheme:"default",toolbarTheme:"light"},editor:{defaultModel:"edit&preview"}};if(e.isReadonly()){t.editor.defaultModel="previewOnly";return t}t.toolbars={bubble:["bold","italic","underline","strikethrough","color","size"],float:["header","code"]};if(yunj.isSmallScreen()){t.toolbars.toolbar=e.args.modeConfig.cherry.mobileToolbar}else{t.toolbars.toolbar=e.args.modeConfig.cherry.toolbar;t.toolbars.toolbarRight=e.args.modeConfig.cherry.toolbarRight}t.callback={fileUpload:function(e,t){if(/image/i.test(e.type)){yunj.fileUpload(e).then(e=>{t(e.data.url)}).catch(e=>{yunj.error(e)})}else{yunj.msg("当前仅支持图片上传")}},fileUploadMulti:function(o,t){let i=[];for(let r=0;r<o.length;r++){let e=o[r];if(!/image/i.test(e.type)){yunj.msg("当前仅支持图片上传");return}let t=new Promise((t,r)=>{yunj.fileUpload(e).then(e=>{t({url:e.data.url,params:{name:e.data.fileName}})}).catch(e=>{r(e)})});i.push(t)}Promise.all(i).then(e=>{t(e)}).catch(e=>{yunj.error(e)})}};return t}layout_control_editormd(){let e=this;return`<div class="layui-input-inline yunj-form-item-control"><div id="${e.markdownContainerId}" style="width: auto;"><textarea></textarea></div></div>`}async render_before_editormd(){let e=this;r.jQuery=i;r.$=i;await yunj.includeCss("/static/yunj/libs/editor.md/css/editormd.min.css");await yunj.includeJs("/static/yunj/libs/editor.md/editormd.min.js");return"done"}async render_done_editormd(){let r=this;await new Promise(e=>{let t=r.get_options_editormd();t.onload=()=>{e("done")};r.markdown=editormd(r.markdownContainerId,t)});return"done"}set_value_editormd(e=""){let t=this;t.markdown.setMarkdown(e)}get_value_editormd(){let e=this;return e.markdown.getMarkdown()}get_options_editormd(){let e=this;return{width:"auto",height:e.args.modeConfig.editormd.height,path:"/static/yunj/libs/editor.md/lib/",watch:e.args.modeConfig.editormd.watch,placeholder:e.args.modeConfig.editormd.placeholder,autoFocus:true,readOnly:e.isReadonly(),taskList:true,tex:true,flowChart:true,sequenceDiagram:true,syncScrolling:"single",htmlDecode:"style,script,iframe|filterXSS",imageUpload:true,imageFormats:e.args.modeConfig.editormd.imageFormats,imageUploadURL:yunj.fileUploadUrl("editormd"),toolbarIcons:()=>{return e.args.modeConfig.editormd.toolbar},toolbarIconsClass:{"align-left":"fa-align-left","align-center":"fa-align-center","align-right":"fa-align-right","align-justify":"fa-align-justify",video:"fa-file-video-o"},lang:{toolbar:{"align-left":"左对齐","align-center":"居中对齐","align-right":"右对齐","align-justify":"两端对齐",video:"插入视频"}},toolbarHandlers:{"align-left":(e,t,r,o)=>{e.replaceSelection(`<p align="left">${o}</p>`);o===""&&e.setCursor(r.line,r.ch+1)},"align-center":(e,t,r,o)=>{e.replaceSelection(`<p align="center">${o}</p>`);o===""&&e.setCursor(r.line,r.ch+1)},"align-right":(e,t,r,o)=>{e.replaceSelection(`<p align="right">${o}</p>`);o===""&&e.setCursor(r.line,r.ch+1)},"align-justify":(e,t,r,o)=>{e.replaceSelection(`<p align="justify">${o}</p>`);o===""&&e.setCursor(r.line,r.ch+1)},video:(e,t,r,o)=>{e.replaceSelection(`\r\n<video src="http://xxxx.com/xxxx.mp4" style="width: 100%; height: 100%;" controls="controls"></video>\r\n`);o===""&&e.setCursor(r.line,r.ch+1)}}}}reloadEditormd(){let e=this;let t=e.get_options_editormd();t.markdown=e.getValue();e.markdown=editormd(e.markdownContainerId,t)}defineExtraEventBind(){let e=this}}e("FormFieldMarkdown",l)});