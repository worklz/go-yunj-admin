layui.define(["FormField","yunj","jquery","table"],function(e){let a=window;let r=document;let l=layui.FormField;let n=layui.jquery;let i=layui.table;class t extends l{constructor(e={}){super(e);this.layTableId="";this.layTable=null;this.layTableSortable=null;this.layTableSortableBoxFlag=null}defineExtraArgs(){let e=this;return{maxHeight:"300",cols:[],addAction:true,delAction:true,sortAction:true}}handleArgs(e){let l=e.maxHeight;if(l){e.maxHeight=e.maxHeight.toString().replace("px","")}let t=e.cols;t=t?t:[];if(t){if(!yunj.isArray(t)){throw new Error("类型[table]配置[cols]格式错误")}for(let l=0;l<t.length;l++){let e=t[l];if(!yunj.isObj(e)){throw new Error(`类型[table]配置[cols][${l}]格式错误`)}e=yunj.objSupp(e,{title:"",field:"",width:"",verify:"",readonly:false});if(!e.title){throw new Error(`类型[table]配置[cols][${l}][title]不能为空`)}if(!e.field){throw new Error(`类型[table]配置[cols][${l}][field]不能为空`)}if(e.verify.indexOf("table")!==-1){throw new Error(`类型[table]配置[cols][${l}][verify]验证规则不能包含table`)}if(!yunj.isBool(e.readonly)){throw new Error(`类型[table]配置[cols][${l}][readonly]格式错误`)}t[l]=e}e.cols=t}let a=e.verify;if(a.indexOf("table")===-1)e.verify+=(a?"|":"")+"table:"+yunj.base64Encode(JSON.stringify(e.cols));return e}async renderBefore(){let l=this;let t=`${l.id}_table`;l.layTableId=t;let e=`${l.layTableId}_event_bind_cols_require_mark`;if(yunj.isUndefined(a[e])){a[e]=true;n(r).bind(`${l.layTableId}_render_done`,function(){let i=n(`.layui-table-view[lay-table-id="${l.layTableId}"] .layui-table-box .layui-table-header table thead tr`);l.args.cols.forEach(e=>{let{field:l,verify:t}=e;let a=i.find(`th[data-field="${l}"] .layui-table-cell`);if(t.indexOf("require")!==-1&&a.length>0&&a.find("span.require").length<=0){a.append(`<span class="require">*</span>`)}})})}if(!l.args.readonly&&l.args.sortAction){l.layTableSortableBoxFlag=`div[lay-table-id=${t}] .layui-table-box .layui-table-main tbody`;await yunj.includeJs("/static/yunj/libs/Sortable/Sortable.min.js");let e=`${l.layTableId}_event_bind_sort`;if(yunj.isUndefined(a[e])){a[e]=true;n(r).bind(`${l.layTableId}_render_done`,function(){let e={handle:`.yunj-form-table-sort-item`,animation:150,ghostClass:"yunj-form-table-sort-item-checked",onUpdate:function(e){l.layTableSortExec(e)}};l.layTableSortable=new Sortable(r.querySelector(l.layTableSortableBoxFlag),e)})}}return"done"}layoutControl(){let e=this;let l=`<table class="layui-table" id="${e.layTableId}" lay-filter="${e.layTableId}"></table>`;return`<div class="layui-input-inline yunj-form-item-control">${l}</div>`}async renderDone(){let l=this;let t={elem:`#${l.layTableId}`,loading:false,maxHeight:300,data:[],done:function(e){i.resize(this.id);n(r).trigger(`${l.layTableId}_render_done`)}};if(l.args.maxHeight){t.maxHeight=l.args.maxHeight}t.cols=[l.getLayTableArgsByCols()];if(!l.args.readonly&&l.args.addAction){let e=`<script type="text/html" id="${l.id}_pagebar_templet">
                                        <div class="layui-btn-group">
                                            <button type="button" class="layui-btn layui-btn-xs" lay-event="add">
                                                <i class="layui-icon layui-icon-addition"></i>追加
                                            </button>
                                        </div>
                                    </script>`;n(r).find("body").append(e);t.pagebar=`#${l.id}_pagebar_templet`}l.layTable=i.render(t);return"done"}getLayTableArgsByCols(){let a=this;let i=[];if(!a.args.readonly&&a.args.sortAction){let e=`<script type="text/html" id="${a.layTableId}_sort_templet">
                                        <div class="yunj-form-table-sort-item" title="拖拽排序" data-idx="{{d.LAY_INDEX}}">
                                            <i class="yunj-icon yunj-icon-sort-circle"></i>
                                        </div>
                                    </script>`;n(r).find("body").append(e);i.push({title:"排序",width:40,align:"center",templet:`#${a.layTableId}_sort_templet`})}for(let t=0;t<a.args.cols.length;t++){let e=a.args.cols[t];let l={title:e.title,field:e.field};if(e.width){l.width=e.width}if(!a.args.readonly&&!e.readonly){l.edit="text"}i.push(l)}if(!a.args.readonly){let l="";if(a.args.delAction){l+=`<button type="button" class="layui-btn layui-btn-xs layui-bg-red" lay-event="del">
                                            <i class="layui-icon layui-icon-delete"></i>
                                        </button>`}if(l){let e=`<script type="text/html" id="${a.layTableId}_action_templet">
                                        <div class="layui-btn-group">${l}</div>
                                    </script>`;n(r).find("body").append(e);i.push({title:"操作",width:80,align:"center",templet:`#${a.layTableId}_action_templet`})}}return i}setValue(e=""){let l=this;if(e&&yunj.isString(e)&&yunj.isJson(e)){e=JSON.parse(e)}if(!e||!yunj.isArray(e)){e=[]}l.layTable.reload({data:e})}getValue(){let e=this;return i.getData(e.layTableId)}layTableSortExec(e){let l=this;let t=e.oldIndex;let a=e.newIndex;let i=l.getValue();let r=i.splice(t,1)[0];i=i.slice(0,a).concat(r,i.slice(a));l.setValue(i)}defineExtraEventBind(){let a=this;if(!a.args.readonly){i.on(`tool(${a.layTableId})`,function(l){let t=l.index;switch(l.event){case"del":let e=a.getValue();e=[...e.slice(0,t),...e.slice(t+1)];a.setValue(e);break}});i.on(`pagebar(${a.layTableId})`,function(t){switch(t.event){case"add":let e=a.getValue();let l={};a.args.cols.forEach(e=>{l[e.field]=""});e.push(l);a.setValue(e);break}})}}}e("FormFieldTable",t)});