layui.define(["FormField","FormFieldActions","yunj","jquery"],function(e){let t=layui.FormField;let n=layui.FormFieldActions;let r=window;let c=document;let h=layui.jquery;class l extends t{constructor(e={}){super(e);this.mode=null;this.retractLevel=null;this.nodes=null;this.ztreeEl=null;this.ztree=null;this.allOptional=null;this.nodeIdxMap=null;this.showBoxEl=null;this.itemsBoxEl=null;this.selectPopupContentEl=null;this.actionRequireArgs={event:"",type:"",title:"",icon:"",url:"",confirmText:"",auth:""}}defineExtraArgs(){let e=this;return{mode:"checkbox",nodes:[],nodeIdKey:"id",nodePidKey:"pid",nodeNameKey:"name",retractLevel:-1,allOptional:false,dragSort:false,options:[]}}handleArgs(e){let t=this;t.handleArgsByNodes(e);switch(e.mode){case"checkbox":if(e.verify.indexOf("arrayIn")===-1)e.verify+=(e.verify?"|":"")+`arrayIn:${t.getArgsAllowNodeIds(e).join(",")}`;break;case"radio":if(e.verify.indexOf("in")===-1)e.verify+=(e.verify?"|":"")+`in:${t.getArgsAllowNodeIds(e).join(",")}`;break}if(!yunj.isBool(e.dragSort)&&e.dragSort!=="level"){throw new Error("类型[tree]配置[dragSort]错误")}t.handleArgsByOptions(e);return e}handleArgsByNodes(n){let e=this;let l=n.nodes;if(l.length<=0){return}let i=n.nodeIdKey;let o=n.nodePidKey;if(n.mode==="checkbox"||n.mode==="radio"){if(!l[0].hasOwnProperty("hasSub")){for(let e=0;e<l.length;e++){let n=l[e];let r=false;for(let t=0;t<l.length;t++){let e=l[t];if(e[o].toString()===n[i].toString()){r=true;break}}n.hasSub=r;l[e]=n}}for(let t=0;t<l.length;t++){let e=l[t];if(e.hasOwnProperty("nocheck")){continue}e.nocheck=!n.allOptional&&!!e.hasSub}}n.nodes=l}handleArgsByOptions(e){let n=this;let r=e.options;for(let t=0;t<r.length;t++){let e=r[t];if(yunj.isString(e)){e={event:e}}if(e.event==="rename"){e=Object.assign({},e,{event:"rename",title:"重命名",icon:"yunj-icon-rename"})}else if(e.event==="remove"){e=Object.assign({},e,{event:"remove",title:"删除",icon:"yunj-icon-remove"})}e=yunj.objSupp(e,n.actionRequireArgs);if(e.event.length<=0){throw new Error("类型[tree]配置[options][event]不能为空")}if(e.type==="openTab"||e.type==="openPopup"){if(!e.url){throw new Error("类型[tree]配置[options][type]=openTab或openPopup时，对应url不能为空")}}r[t]=e}e.options=r}getArgsAllowNodeIds(e){let t=this;let n=e.nodes;let r=e.nodeIdKey;let l=[];for(let t=0;t<n.length;t++){let e=n[t];if(!(e.nocheck??false)&&!(e.readonly??false)){l.push(e[r])}}return l}defineBoxHtml(){let e=this;return`<div class="layui-form-item yunj-form-item yunj-form-tree" id="${e.id}">__layout__</div>`}ztreeHtml(){let e=this;let t=e.args;return`<ul id="${e.id}_ztree" class="ztree"></ul>`}layoutControl(){let e=this;let t=e.ztreeHtml();if(e.isCheckMode()){t=`<div class="show-box">
                                    <div class="items-box"></div>
                                </div>`}return`<div class="layui-input-inline yunj-form-item-control">${t}</div>`}async renderBefore(){let e=this;e.mode=e.args.mode;e.retractLevel=e.args.retractLevel;if(e.isCheckMode()){e.allOptional=e.args.allOptional;e.setCheckNodes()}if(!r.hasOwnProperty("jQuery")){r.jQuery=h}await yunj.includeCss("/static/yunj/libs/zTree_v3/css/metroStyle/metroStyle.css");await yunj.includeJs("/static/yunj/libs/zTree_v3/js/jquery.ztree.core.js");await yunj.includeJs("/static/yunj/libs/zTree_v3/js/jquery.ztree.excheck.js");await yunj.includeJs("/static/yunj/libs/zTree_v3/js/jquery.ztree.exedit.js");return"done"}getNodeLevel(e,t){let n=this;let r=n.nodeIdxMap;if(!r.has(e))return 0;let l=n.args.nodePidKey;let i=r.get(e);let o=t[i];if(o.hasOwnProperty("level"))return o.level;if(!o[l]||o[l]==="0")o.level=0;else o.level=n.getNodeLevel(o[l],t)+1;return o.level}setCheckNodes(){let r=this;let l=r.args.nodes;let i=r.args.nodeIdKey;let e=r.args.nodePidKey;let o=new Map;let t=l.length;for(let n=0;n<t;n++){l[n][i]=l[n][i].toString();let e=l[n];let t=e[i];o.set(t,n);if(e.hasOwnProperty("readonly")&&e.readonly){l[n].chkDisabled=true}l[n].open=true;r.setCheckNodeChildIdsAttr(l,e)}r.nodeIdxMap=o;if(r.retractLevel>=0){l.forEach(e=>{let t=r.getNodeLevel(e[i],l);e.open=t<r.retractLevel})}r.nodes=l}getNodeChildIdsAttr(){let e=this;return"child"+yunj.ucfirst(e.args.nodeIdKey)+"s"}setCheckNodeChildIdsAttr(n,r){let l=this;let i=l.args.nodeIdKey;let o=l.args.nodePidKey;let s=l.getNodeChildIdsAttr();if(!r.hasOwnProperty(s)){let t=[];for(let e=0;e<n.length;e++){if(r[i].toString()===n[e][o].toString()){t.push(n[e][i].toString());if(!n[e].hasOwnProperty(s)){l.setCheckNodeChildIdsAttr(n,n[e])}t=t.concat(n[e][s])}}r[s]=t}}renderDone(){let e=this;if(e.isCheckMode()){e.showBoxEl=e.boxEl.find(".show-box");e.itemsBoxEl=e.boxEl.find(".show-box .items-box");e.fieldActions=new n({fieldObj:e,fieldValueElSelector:`.show-box>.items-box`,actions:{contentClear:null,selectPopup:{contentHtml:e.getCheckModeSelectPopupContentHtml,showAfter:e.renderCheckModeSelectTree}}});e.selectPopupContentEl=e.fieldActions.getActionObj("selectPopup").selectContentEl;return}e.ztreeEl=e.boxEl.find(`#${e.id}_ztree`)}getCheckModeSelectPopupContentHtml=e=>{let r=this;return new Promise((e,t)=>{let n=null;if(!r.ztreeEl){n=r.ztreeHtml()}e(n)})};setValue(e=""){let t=this;if(t.isCheckMode()){t.setCheckValue(e)}else{t.setEditValue(e)}}setCheckValue(e=""){let o=this;if(yunj.isScalar(e)&&e)e=o.mode==="radio"?[e]:yunj.isJson(e)?JSON.parse(e):yunj.isString(e)&&e.indexOf(",")!==-1?e.split(","):[e];e=yunj.isArray(e)?e:[];let s=JSON.parse(JSON.stringify(e));let a="";for(let i=0,e=s.length;i<e;i++){let e=s[i].toString();if(!o.nodeIdxMap.has(e))continue;let t=o.nodeIdxMap.get(e);let n=o.nodes[t];if(n.nocheck??false)continue;let r=n.name;let l=o.args.readonly?"":'<i class="layui-icon layui-icon-close-fill item-remove" title="删除"></i>';a+=`<div class="item" data-value="${e}">
                                    <span class="txt" title="${r}">${r}</span>
                                    ${l}
                                </div>`}o.itemsBoxEl.html(a);o.setCheckModeSelectTreeNodesChecked()}setEditValue(e=""){let n=this;let r=[];if(yunj.isArray(e)){r=e}else if(yunj.isJson(e)){r=JSON.parse(e)}if(r.length<=0){r=n.args.nodes}let l=n.args.nodeIdKey;r.forEach(t=>{t[l]=t[l].toString();if(n.retractLevel>=0){let e=n.getNodeLevel(t[l],r);t.open=e<n.retractLevel}else{t.open=true}});n.nodes=r;n.initEditZtree()}initEditZtree(){let l=this;if(l.ztree)return l.ztree;let e={view:{showIcon:false},data:{key:{name:l.args.nodeNameKey},simpleData:{enable:true,idKey:l.args.nodeIdKey,pIdKey:l.args.nodePidKey}},edit:{enable:true,showRemoveBtn:false,showRenameBtn:false,drag:{isCopy:false,isMove:false,prev:false,inner:false,next:false}},callback:{onRename:function(e,t,n,r){h(`#${l.id}_ztree .yunj-tree-node-option`).unbind().remove();l.setCurrEditNodes()}}};if(!l.args.readonly){l.handleEditZtreeSettingByDragSort(e);l.handleEditZtreeSettingByOptions(e)}l.ztree=h.fn.zTree.init(l.ztreeEl,e,l.nodes)}handleEditZtreeSettingByDragSort(e){let a=this;let t=a.args.dragSort;let d=a.args.nodeIdKey;let u=a.args.nodePidKey;if(t){a.nodes.forEach(e=>{if(!e.hasOwnProperty("drag")){e.drag=true}});e.edit.drag.isMove=true;e.edit.drag.prev=true;e.edit.drag.next=true;e.edit.drag.inner=t===true;e.callback.beforeDrag=function(e,n){for(let e=0,t=n.length;e<t;e++){if(n[e].drag===false){yunj.msg(`[${n[e].name}]节点禁止拖拽`);return false}}return true};e.callback.onDrop=function(e,t,n,r,l){a.setCurrEditNodes()};if(t==="level"){e.callback.beforeDrop=function(e,t,n,r){let l=t[0][d];let i=yunj.arrayColumn(a.nodes,u,d);let o=i[l]?i[l].toString():null;let s=n&&n[u]?n[u].toString():null;if(o!==s){yunj.msg("当前仅允许同级排序");return false}return true}}}}handleEditZtreeSettingByOptions(e){let o=this;let s=o.args.options;if(s.length<=0){return}e.view.addHoverDom=function(e,r){if(r.hasOwnProperty("readonly")&&r.readonly){return}let t=h("#"+r.tId+"_a");if(t.find(".yunj-tree-node-option").length>0){return}let n;let l=r.events;if(l){if(yunj.isJson(l)){l=JSON.parse(l)}else if(yunj.isString(l)&&l.indexOf(",")!==-1){l=l.split(",")}l=yunj.isArray(l)?l:[l]}l=yunj.isArray(l)?l:[];if(l.length>0){let t=yunj.arrayColumn(s,null,"event");r.events.forEach(e=>{if(t.hasOwnProperty(e)){n.push(t[e])}})}else{n=s}let i="";n.forEach(e=>{i+=`<span class="yunj-tree-node-option" id="${o.id}_${e.event}" title="${e.title}" data-args="${encodeURIComponent(JSON.stringify(e))}">
                                        ${e.icon?`<i class="${yunj.iconClass(e.icon)}"></i>`:e.title}
                                    </span>`});t.append(i);h(`#${o.id}_ztree .yunj-tree-node-option`).bind("click",function(e){let t=h(this);let n=JSON.parse(decodeURIComponent(t.data("args")));if(n.confirmText)yunj.confirm(n.confirmText,function(){o.handleEditEvent(r,n)});else o.handleEditEvent(r,n);e.stopPropagation()})};e.view.removeHoverDom=function(e,t){let n=h(`#${o.id}_ztree .yunj-tree-node-option`);n.length>0&&n.unbind().remove()}}handleEditEvent(i,o){let s=this;let a=o.event;let d=s.args.nodeIdKey;let u=s.args.nodePidKey;switch(o.type){case"openPopup":let e={[d]:i[d]};let t=o.title+":"+i.name;yunj.openPopup(yunj.handlePageUrl(yunj.urlPushParam(o.url,e)),t);break;case"openTab":let n={[d]:i[d]};let r=o.title+":"+i.name;yunj.openTab(yunj.handlePageUrl(yunj.urlPushParam(o.url,n)),r);break;case"asyncEvent":let l={event:a,[d]:i[d],name:i.name,[u]:i[u]};yunj.request({url:o.url?o.url:s.url,data:l,type:"post",loading:true}).then(e=>{h(c).trigger(`yunj_tree_${s.id}_async_event_done`,[a,i,l,e])}).catch(e=>{yunj.error(e)});break;default:switch(a){case"rename":s.ztree.editName(i);break;case"remove":s.ztree.removeNode(i);s.setCurrEditNodes();break}h(c).trigger(`yunj_tree_${s.id}_${a}`,[i])}}setCurrEditNodes(e=[]){let t=this;let n=[];let r=e.length;if(r<=0){e=t.ztree.getNodes()}e.forEach(e=>{n.push(t.handleEditNode(e));if(e.hasOwnProperty("children")&&e.children.length>0){n.push(...t.setCurrEditNodes(e.children))}});if(r<=0&&n.length>=0){t.nodes=n}return n}handleEditNode(e){let t=this;let n=t.args.nodeIdKey;let r=t.args.nodePidKey;return{[n]:e[n],[r]:e[r],name:e.name,drag:e.drag}}getValue(){let e=this;return e.isCheckMode()?e.getCheckValue():e.getEditValue()}getCheckValue(){let e=this;let t=e.itemsBoxEl.find(".item");if(t.length<=0)return"";let n=[];t.each(function(){n.push(h(this).data("value").toString())});if(n.length<=0)return"";return e.mode==="radio"?n[0]:n}getEditValue(){let e=this;let t=e.args.nodeIdKey;let n=e.args.nodePidKey;let r=[];if(e.nodes&&e.nodes.length>0){e.nodes.forEach(e=>{r.push({[t]:e[t],name:e.name,[n]:e[n]})})}return r}renderCheckModeSelectTree=()=>{let e=this;e.initCheckZtree();e.setCheckModeSelectTreeNodesChecked()};setCheckModeSelectTreeNodesChecked(){let e=this;let n=e.ztree;if(!n)return;let r=e.args.nodeIdKey;let t=e.ztree.getCheckedNodes(true);t.forEach(e=>{n.checkNode(e,false,false,false)});let l=e.getCheckValue();if(l.length<=0){return}if(!yunj.isArray(l)){l=[l]}l.forEach(e=>{let t=n.getNodeByParam(r,e);if(!t)return;n.checkNode(t,true,false,false)})}initCheckZtree(){let o=this;if(o.ztree)return o.ztree;if(!o.ztreeEl){o.ztreeEl=o.boxEl.find(`#${o.id}_ztree`)}let s=o.args.nodeIdKey;let e={view:{showIcon:false},check:{enable:true},data:{key:{name:o.args.nodeNameKey},simpleData:{enable:true,idKey:o.args.nodeIdKey,pIdKey:o.args.nodePidKey}},edit:{enable:true,showRemoveBtn:false,showRenameBtn:false},callback:{onClick:function(e,t,n,r){o.ztree.checkNode(n,!n.checked,true);let l=o.ztree.getCheckedNodes(true);let i=[];for(let e=0;e<l.length;e++){i.push(l[e][s])}o.setValue(i)},onCheck:function(e,t,n){let r=o.ztree.getCheckedNodes(true);let l=[];for(let e=0;e<r.length;e++){l.push(r[e][s])}o.setValue(l)}}};switch(o.mode){case"radio":e.check.chkStyle="radio";e.check.radioType="all";break}o.ztree=h.fn.zTree.init(o.ztreeEl,e,o.nodes);return o.ztree}defineExtraEventBind(){let s=this;if(s.isCheckMode()){s.boxEl.on("click",".item-remove",function(e){if(s.args.readonly)return false;let t=h(this).parent(".item");let n=t.data("value").toString();let r=s.nodeIdxMap.get(n);let l=s.nodes[r];let i=[n].concat(l[s.getNodeChildIdsAttr()]);let o=s.selectPopupContentEl.is(":visible");i.forEach(e=>{let t=s.itemsBoxEl.find(`[data-value="${e}"]`);if(t.length>0){t.remove()}if(o){let e=s.ztree.getNodeByParam(s.args.nodeIdKey,n);if(!e)return;s.ztree.checkNode(e,false,false,false)}});e.stopPropagation()})}}isCheckMode(){return this.args.mode==="checkbox"||this.args.mode==="radio"}}e("FormFieldTree",l)});