layui.define(["FormField","FormFieldActions","yunj","jquery"],function(e){let t=layui.FormField;let i=layui.FormFieldActions;let l=window;let n=document;let o=layui.jquery;class s extends t{constructor(e={}){super(e);this.showBoxEl=null;this.itemsBoxEl=null;this.selectPopupContentEl=null;this.xhr=null;this.keywordsChangeSearchTimer=null}defineExtraArgs(){let e=this;return{multi:true,options:[],optionIdKey:"id",optionNameKey:"name"}}defineBoxHtml(){let e=this;return`<div class="layui-form-item yunj-form-item yunj-form-dropdown-search" id="${e.id}">__layout__</div>`}layoutControl(){let e=this;let t=`<div class="show-box">
                                    <div class="items-box"></div>
                                </div>`;return`<div class="layui-input-inline yunj-form-item-control">${t}</div>`}renderDone(){let e=this;e.showBoxEl=e.boxEl.find(".show-box");e.itemsBoxEl=e.boxEl.find(".items-box");e.fieldActions=new i({fieldObj:e,fieldValueElSelector:`.show-box>.items-box`,actions:{contentClear:null,selectPopup:{contentHtml:e.getSelectPopupContentHtml,showAfter:e.renderSelectItems}}});e.selectPopupContentEl=e.fieldActions.getActionObj("selectPopup").selectContentEl}setValue(e=""){let t=this;if(yunj.isScalar(e)&&e)e=yunj.isJson(e)?JSON.parse(e):yunj.isString(e)&&e.indexOf(",")!==-1?e.split(","):[e];if(!yunj.isArray(e))e=[];t.itemsClear();if(e.length<=0)return;t.getSelectedItems({[t.getOptionIdsKey()]:e.join(",")}).then(e=>{t.itemsAppend(e)})}getValue(){let e=this;let t=e.itemsBoxEl.find(".item");if(t.length<=0)return"";let i=[];t.each(function(){i.push(o(this).data("value").toString())});if(i.length<=0)return"";return e.args.multi?i:i[0]}itemsAppend(e){let o=this;if(!yunj.isArray(e)||yunj.isEmptyArray(e))return;e.forEach((e,t)=>{let i=e[o.args.optionIdKey];let l=e[o.args.optionNameKey];if(o.itemsBoxEl.find(`.item[data-value="${i}"]`).length<=0){let e=o.args.readonly?"":'<i class="layui-icon layui-icon-close-fill item-remove" title="删除"></i>';let t=`<div class="item" data-value="${i}">
                                    <span class="txt" title="${l}">${l}</span>
                                    ${e}
                                </div>`;o.itemsBoxEl.append(t)}let n;if(o.selectPopupContentEl&&(n=o.selectPopupContentEl.find(`dd[data-value="${i}"]`))&&n.length>0){n.addClass("active")}})}itemsClear(){let e=this;e.itemsBoxEl.html("");e.selectPopupContentEl&&e.selectPopupContentEl.find("dd").removeClass("active")}itemsRemove(e){let l=this;if(!yunj.isArray(e)||yunj.isEmptyArray(e))return;e.forEach(e=>{let t=l.itemsBoxEl.find(`.item[data-value="${e}"]`);if(t.length>0){t.remove()}let i;if(l.selectPopupContentEl&&(i=l.selectPopupContentEl.find(`dd[data-value="${e}"]`))&&i.length>0){i.removeClass("active")}})}getSelectedItems(t={}){let r=this;t=yunj.objSupp(t,{keywords:"",[r.getOptionIdsKey()]:""});if(yunj.isString(r.args.options)){o(n).trigger(`yunj_form_field_${r.id}_request_param`,[t]);let e=yunj.urlPushParam(r.args.options,t);if(r.xhr)r.xhr.abort();return new Promise((t,i)=>{r.xhr=new XMLHttpRequest;r.xhr.open("GET",e,true);r.xhr.responseType="json";r.xhr.onload=function(){if(r.xhr.status!==200){i(r.xhr.status);return false}let e=r.xhr.response;if(e.errcode!==0){i(e.msg);return false}t(e.data)};r.xhr.send()})}if(yunj.isArray(r.args.options)){let i=t.keywords;let l=t[r.getOptionIdsKey()];let n=new RegExp(i,"i");l=l?l.indexOf(",")!==-1?l.split(","):[l.toString()]:[];let o=[];let s=r.args.options;for(let t=0;t<s.length;t++){let e=s[t];if(l.length>0&&l.indexOf(e[r.args.optionIdKey].toString())===-1){continue}if(i&&e[r.args.optionNameKey].toString().search(n)===-1){continue}o.push(e)}return new Promise((e,t)=>{e(o)})}}getSelectPopupContentHtml=e=>{let t=this;let{isUp:o}=e;return new Promise((e,t)=>{let i=`<input type="text" class="layui-input" name="keywords" placeholder="关键词" autocomplete="off">`;let l=`<dl class="items-box"></dl>`;let n="";if(o){n=l+i}else{n=i+l}e(n)})};renderSelectItems=()=>{let s=this;let t=s.selectPopupContentEl.find(".items-box");let e=s.selectPopupContentEl.find("input[name=keywords]");t.html(`<dd>搜索中...</dd>`);let i={keywords:e.length>0?e.val():""};s.getSelectedItems(i).then(e=>{if(e.length<=0){t.html(`<dd>暂无内容</dd>`);return}let n=s.getValue();n=yunj.isArray(n)?n:[n];let o="";e.forEach((e,t)=>{let i=e[s.args.optionIdKey];let l=e[s.args.optionNameKey];o+=`<dd class="${n.indexOf(i.toString())!==-1?"active":""}" data-value="${i}" title="${l}">${l}</dd>`});t.html(o)})};defineExtraEventBind(){let l=this;l.boxEl.on("keyup","input[name=keywords]",function(e){if(l.keywordsChangeSearchTimer)clearTimeout(l.keywordsChangeSearchTimer);l.keywordsChangeSearchTimer=setTimeout(function(){l.renderSelectItems()},500)});l.boxEl.on("click",".items-box dd",function(e){e.stopPropagation();let t=o(this);if(!t.hasClass("active")){let e=[{[l.args.optionIdKey]:t.data("value"),[l.args.optionNameKey]:t.attr("title")}];if(!l.args.multi){l.itemsClear()}l.itemsAppend(e)}else{let e=[t.data("value")];l.itemsRemove(e)}});l.boxEl.on("click",".show-box .item",function(e){e.stopPropagation();yunj.copy(o(this).find(".txt").text())});l.boxEl.on("click",".item-remove",function(e){e.stopPropagation();if(l.args.readonly)return;let t=o(this).parent(".item");let i=[t.data("value")];l.itemsRemove(i)})}getOptionIdsKey(){let e=this;return e.args.optionIdKey+"s"}}e("FormFieldDropdownSearch",s)});