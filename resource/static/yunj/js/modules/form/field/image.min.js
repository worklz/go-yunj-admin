layui.define(["FormField","jquery","yunj","upload"],function(e){let t=layui.FormField;let l=window;let s=document;let o=layui.jquery;let i=layui.upload;class r extends t{constructor(e={}){super(e);this.previewBoxEl=null;this.chooseFiles={};this.triggerUploadSelector=`#${this.id} .upload-trigger`;this.sortable=null}defineExtraArgs(){let e=this;return{multi:false,size:yunj.config("file.upload_img_size"),ext:yunj.config("file.upload_img_ext"),text:"图片上传"}}handleArgs(e){if(this.isMulti(e.multi)){if(e.verify.indexOf("urls")===-1)e.verify+=(e.verify?"|":"")+"urls"}else{if(e.verify.indexOf("url")===-1)e.verify+=(e.verify?"|":"")+"url"}return e}layoutControl(){let e=this;let t=`<div class="image-box ${e.isMulti()?"multi":""}">
                                    <div class="preview-box">
                                        <div class="select-box ${e.isReadonly()?"readonly":""}" title="${e.isReadonly()?"禁用":"选择图片上传"}">
                                            <div><i class="layui-icon layui-icon-upload upload-icon"></i><span class="limit-count-desc"></span></div>
                                            <div>${e.args.text}</div>
                                        </div>
                                    </div>
                                    <i class="upload-trigger"></i>
                                </div>`;return`<div class="layui-input-inline yunj-form-item-control">${t}</div>`}descContent(){let e=this;let t=e.args.desc;if(!t){t=`允许上传大小不超过 ${e.args.size}MB 且格式为 ${e.args.ext.replace(/,/g,"/")} 的图片。`;if(e.isMulti()){t+=`允许最大上传数 ${e.getMultiLimitCount()}。`}}return t}async renderDone(){let i=this;i.previewBoxEl=i.boxEl.find(".preview-box");if(i.isMulti()&&!i.isReadonly()){await yunj.includeJs("/static/yunj/libs/Sortable/Sortable.min.js");let t=`${i.id}_event_bind_sort`;if(yunj.isUndefined(l[t])){l[t]=true;let e={handle:`.preview-box>.item`,animation:150,ghostClass:"sort-checked",onStart:function(e){i.sortDataIds=i.sortable.toArray()},onEnd:function(e){i.sortable.sort(i.sortDataIds)}};i.sortable=new Sortable(s.querySelector(`#${i.id} .preview-box`),e)}}return"done"}setValue(e=""){let i=this;let t=e;if(yunj.isString(t)&&t.length>0)t=yunj.isJson(t)?JSON.parse(t):t.indexOf(",")!==-1?t.split(","):[t];if(!yunj.isArray(t))t=[];i.previewBoxEl.hide();i.getPreviewItemHtml(t).then(e=>{i.setPreviewBoxHtml(e);let t=e.length>0&&i.isReadonly()?"none":"flex";i.boxEl.find(".select-box").css("display",t)})}getValue(){let e=this;let t=[];e.previewBoxEl.find(".item img").each(function(){let e=o(this).attr("src");if(!e||!yunj.isString(e)||e.length>2e3){return true}t.push(yunj.urlAppendDomain(e))});return t.length>0?e.isMulti()?t:t[0]:""}setMultiLimitCountDesc(){let e=this;if(!e.isMulti()){return}let t=e.previewBoxEl.children(".item").length+"/"+e.getMultiLimitCount();e.boxEl.find(".select-box .limit-count-desc").html(t).show()}setPreviewBoxHtml(e){let t=this;t.previewBoxEl.children(".item").remove();t.previewBoxEl.children(".select-box").before(e);t.previewBoxEl.css("display","flex");t.setMultiLimitCountDesc()}appendPreviewBoxHtml(e){let t=this;t.previewBoxEl.children(".select-box").before(e);t.previewBoxEl.css("display","flex");t.setMultiLimitCountDesc()}async getPreviewItemHtml(r){let n=this;let a="";for(let o=0,e=r.length;o<e;o++){let e=r[o];let t=e;let i=null;if(yunj.isObj(e)){t=e.src;i=e.index}let l=await yunj.previewImgStyle(t,{width:110,height:110});let s="";if(!n.isReadonly()){s=`<i class="layui-icon layui-icon-delete item-delete" title="删除"></i>`}a+=`<div class="item" ${i?`data-index="${i}"`:""}>
                                <img src="${t}" alt="" title="点击预览" ${yunj.defaultImageAttrOnerror()} ${l}>
                                ${s}
                            </div>`}return a}async setChooseFilesPreview(){let o=this;let t=[];for(let s in o.chooseFiles){if(!o.chooseFiles.hasOwnProperty(s))continue;await new Promise((e,t)=>{let i=o.chooseFiles[s];let l=new FileReader;l.readAsDataURL(i);l.onload=function(){e({index:s,src:this.result})}}).then(e=>{t.push(e)})}let e=await o.getPreviewItemHtml(t);o.isMulti()?o.appendPreviewBoxHtml(e):o.setPreviewBoxHtml(e);for(let e in o.chooseFiles){if(!o.chooseFiles.hasOwnProperty(e))continue;o.setChooseFileUploadStart(e)}}setChooseFileUploadProgress(e,t={}){let i=this;let l={elem:null,rate_num:0};t=yunj.objSupp(t,l);let s=i.chooseFiles[e]||null;if(!s){return}if(!s.hasOwnProperty("uploadProgress")){s.uploadProgress=l}let o=s.uploadProgress;o.elem=o.elem||i.previewBoxEl.find(`.item[data-index=${e}]`);o.rate_num=t.rate_num;if(o.elem.find(".layui-progress").length<=0){let e=`<div class="layui-progress layui-progress-big">
                                          <div class="layui-progress-bar" style="width:0%;">
                                            <span class="layui-progress-text">0%</span>
                                          </div>
                                      </div>`;o.elem.append(e)}let r=t.rate_num+"%";o.elem.find(".layui-progress-bar").css({width:r});o.elem.find(".layui-progress-text").html(r)}setChooseFileUploadStart(t){let i=this;i.setChooseFileUploadProgress(t,{rate_num:0});let l=i.chooseFiles[t].uploadProgress;l.timer=setInterval(function(){let e=l.rate_num;e=e+Math.random()*10|0;e=e>99?99:e;i.setChooseFileUploadProgress(t,{rate_num:e})},300+Math.random()*1e3)}setChooseFileUploadEnd(e,t){let i=this;let l=i.chooseFiles[e]||null;if(!l){return}let s=i.chooseFiles[e].uploadProgress;s.timer&&clearInterval(s.timer);i.setChooseFileUploadProgress(e,{rate_num:100});setTimeout(function(){s.elem.find("img").attr("src",t.url);s.elem.find("img").attr("alt",t.fileName);i.deleteChooseFileUploadData(e)},1e3)}setChooseFileUploadError(e,t=""){let i=this;let l=i.chooseFiles[e]||null;if(!l){return}let s=l.uploadProgress;let o=`<div class="error-tips" title="${t}">${t}</div>`;s.elem.append(o);i.deleteChooseFileUploadData(e)}deleteChooseFileUploadData(e){let t=this;let i=t.chooseFiles[e]||null;if(!i){return}let l=i.uploadProgress||null;if(l){l.timer&&clearInterval(l.timer);l.elem.find(".layui-progress").hide()}delete t.chooseFiles[e]}layuiUploadRender(){let l=this;let e={elem:`#${l.id} .select-box`,url:yunj.fileUploadUrl(),accept:"image",acceptMime:l.args.ext.split(",").map(e=>{return`image/${e}`}).join(","),exts:l.args.ext.replace(/,/g,"|"),auto:false,bindAction:l.triggerUploadSelector,field:"file",size:l.args.size*1024,multiple:l.isMulti(),drag:false,choose:function(e){if(!yunj.isEmptyObj(l.chooseFiles)){yunj.msg("待上传完成后，执行此操作");return false}l.chooseFiles=e.pushFile();if(l.isMulti()){let e=(l.previewBoxEl.find(".item").length|0)+(Object.keys(l.chooseFiles).length|0);let t=l.getMultiLimitCount();if(e>t){yunj.msg(`限制最大上传数 ${t}`);for(let e in l.chooseFiles){if(!l.chooseFiles.hasOwnProperty(e))continue;delete l.chooseFiles[e]}return false}}l.setChooseFilesPreview().then(e=>{o(l.triggerUploadSelector).click()})},done:function(e,t,i){if(e.errcode!==0){l.setChooseFileUploadError(t,e.msg);return false}l.setChooseFileUploadEnd(t,e.data)}};i.render(e)}defineExtraEventBind(){let s=this;if(s.isReadonly()){s.boxEl.on("click",".select-box",function(e){yunj.msg(`只读模式，禁止操作`);e.stopPropagation()})}else{s.layuiUploadRender();s.boxEl.on("click",".preview-box .item-delete",function(e){let t=o(this).parent(".item");let i=t.data("index");s.deleteChooseFileUploadData(i);t.remove();s.setMultiLimitCountDesc();e.stopPropagation()})}s.boxEl.on("click",".preview-box img",function(e){let t=s.getValue();if(t.length<=0)return false;let i=o(this).attr("src");let l=t.indexOf(i);if(l===-1)l=0;yunj.previewImg(t,l)})}isMulti(e=null){let t=this;if(e===null){if(yunj.isUndefined(t._multi)){t._multi=t.args.multi===true||yunj.isPositiveInt(t.args.multi)}return t._multi}return e===true||yunj.isPositiveInt(e)}getMultiLimitCount(){let e=this;e._multiLimitCount=e._multiLimitCount||(yunj.isPositiveInt(this.args.multi)?this.args.multi:9);return e._multiLimitCount}}e("FormFieldImage",r)});