layui.define(["jquery","yunj","TableBuild","treeTable"],function(e){let t=window;let d=document;let b=layui.jquery;let f=layui.treeTable;let l=layui.TableBuild;class a extends l{constructor(e){super(e,"table");this.fieldSort={};this.itemsCount=0;this.items=[];this.layTableId=`yunj_table_${this.tableId}`;this.layTable=null;this.layTableCurrTd=null;this.layEventMark="yunjTableLayEvent";this.layEventLocation={toolbar:"toolbar",defaultToolbar:"defaultToolbar",action:"action"};this.treeDef={customName:{children:"YUNJ_TREE_TABLE_CHILDREN",isParent:"YUNJ_TREE_TABLE_IS_PARENT",icon:"YUNJ_TREE_TABLE_ICON"}};this._initLayTable()}_initBuild(){}_initLayTable(){let e=this;if(!e.isSetCols())throw new Error(`表格[${e.tableId}]未设置[cols]`);let t="yunj-table-lay-table-box";e.tableBoxEl.append(`<div class="${t}" style="padding-top: 0">
                                        <table class="layui-table" id="${e.layTableId}" lay-filter="${e.layTableId}"></table>
                                    </div>`);e.buildBoxEl=e.tableBoxEl.find(`.${t}`)}async render(e=""){let a=this;a._renderBefore();let t=a.table.rawArgs;let l=a.isSetState()?a.getCurrState():null;let i=a.getCurrRequestFilter();let r={elem:"#"+a.layTableId,url:a.table.url,method:"post",where:{[yunj.config("builder.id_key")]:a.tableId,[yunj.config("builder.async_type_key")]:"items",filter:i,sort:a.getCurrRequestSort()},contentType:"application/json",parseData:function(e){let t=e.data;let l=yunj.isObj(t)&&t.hasOwnProperty("items")&&t.items?t.items:[];l.map(e=>{e.is_export=false;return e});a.items=a._handleItems(l);return{code:e.errcode,msg:e.msg,count:a.itemsCount,data:a.items}},tree:{customName:{children:"",isParent:"",name:"",id:"",pid:"",icon:""},view:{iconClose:"",iconOpen:"",iconLeaf:""}},loading:true,text:{none:"暂无相关数据"},autoSort:false,defaultToolbar:[],cols:[],done:function(e){a.resize();b(d).trigger(`yunj_table_${a.tableId}_render_table_done`)}};if(a.isSetPage()){if(a.isSetState()){r.page=yunj.isObj(t.page)&&t.page.hasOwnProperty(l)?t.page[l]:true}else{r.page=yunj.isBool(t.page)?t.page:true}if(a.isSetLimit()){if(a.isSetState()){r.limit=yunj.isObj(t.limit)&&t.limit.hasOwnProperty(l)?t.limit[l]:20}else{r.limit=yunj.isPositiveInt(t.limit)?t.limit:20}}if(a.isSetLimits()){if(a.isSetState()){r.limits=yunj.isObj(t.limits)&&t.limits.hasOwnProperty(l)?t.limits[l]:[10,20,30,40,50,60,70,80,90]}else{r.limits=yunj.isPositiveIntArray(t.limits)?t.limits:[10,20,30,40,50,60,70,80,90]}}}if(!yunj.isEmptyObj(a.fieldSort)){let e=Object.keys(a.fieldSort)[0];r.initSort={field:e,type:a.fieldSort[e]}}if(a.isSetToolbar())await a._setTableArgsByToolbar(r);if(a.isSetDefaultToolbar())a._setTableArgsByDefaultToolbar(r);if(a.isSetTree())a._setTableArgsByTree(r);await a._setTableArgsByCols(r);let n=a.buildBoxEl.find(".layui-table-view");if(n.length>0){n.html(`<div style="flex: 1;text-align: center;">
                                        <i class="layui-icon layui-icon-loading layui-anim layui-anim-rotate layui-anim-loop" style="margin-left: -15px"></i>
                                    </div>`)}await a._setItemsCount(i);a.layTable=f.render(r);console.log(r,a.layTable);a._renderAfter()}async _setTableArgsByToolbar(l){let t=this;let a=t.table.rawArgs;let i={tableId:t.tableId,key:"toolbar"};if(t.isSetState()){let e=t.getCurrState();if(!a.toolbar.hasOwnProperty(e))return;i.state=e;i.options=a.toolbar[e]}else{i.options=a.toolbar}await new Promise(t=>{layui.use("tableToolbar",()=>{layui.tableToolbar(i).render().then(e=>{l.toolbar=`#${e.id}`;t()})})})}_setTableArgsByDefaultToolbar(e){let l=this;let t=l.table.rawArgs;let a=l.getCurrState();let i=[];let r=[];if(l.isSetState()){r=yunj.isObj(t.defaultToolbar)&&t.defaultToolbar.hasOwnProperty(a)?t.defaultToolbar[a]:{}}else{r=yunj.isObj(t.defaultToolbar)?t.defaultToolbar:{}}for(let t in r){if(!r.hasOwnProperty(t))continue;let e=r[t];e.class=yunj.iconClass(e.class);if(t==="filter"||t==="print"){i.push(t)}else if(t==="export"){i.push({title:"数据导出",layEvent:"export",icon:"layui-icon-export"})}else{i.push({title:e.title,layEvent:l.generateLayEvent(l.layEventLocation.defaultToolbar,t,e),icon:e.class})}}if(i.length>0){if(!e.hasOwnProperty("toolbar"))e.toolbar=true;e.defaultToolbar=i}else{e.defaultToolbar=[]}}_setTableArgsByTree(e){let t=this;let l=t.table.rawArgs;let a=t.getCurrState();let i;if(t.isSetState()){i=yunj.isObj(l.tree)&&l.tree.hasOwnProperty(a)?l.tree[a]:{}}else{i=yunj.isObj(l.tree)?l.tree:{}}if(!i||yunj.isEmptyObj(i)){return}let r=t.getCurrPk();e.tree.customName={children:t.treeDef.customName.children,isParent:t.treeDef.customName.isParent,name:"name",id:r,pid:t.treeItemParentField(),icon:t.treeDef.customName.icon}}treeItemParentField(){let e=this;return`p${e.getCurrPk()}`}async _setTableArgsByCols(e){let l=this;let t=l.table.rawArgs;let r=l.getCurrState();let n=[];let s=[];if(l.isSetState()){if(!t.cols.hasOwnProperty(r))return;s=t.cols[r]}else{s=t.cols}let o=l.isSetTree();for(let e in s){if(!s.hasOwnProperty(e))continue;let t=JSON.parse(JSON.stringify(s[e]));let a=yunj.objSupp(t,{field:"",title:"",type:"normal",align:"left",sort:false,fixed:false,hide:false,templet:"",minWidth:80});a=JSON.parse(JSON.stringify(a));if(a.type==="data"){continue}a.hide=false;if(yunj.isBool(t.hide)){a.hide=t.hide}else if(yunj.isString(t.hide)){let e=t.hide.toLowerCase();if(e==="yes"||e==="y"){a.hide=true}else if(e==="mobilehide"){a.hide=yunj.isMobile()}}let i=t["templet"];if(i==="dragSort"&&o){i=""}if(i.length>0){let e={tableId:l.tableId,key:t.field,args:t};if(l.isSetState())e.state=r;await new Promise(l=>{yunj.tableCol(i,e).then(t=>{t.render().then(e=>{a["templet"]=`#${t.id}`;l()}).catch(e=>{console.log(e);yunj.error(e);l()})})})}if(i==="action")a.minWidth=80;n.push(a)}e.cols=[n]}_handleItems(l){let a=this;if(l.length<=0){return}if(a.isSetTree()){let e=a.getCurrPk();let t=a.treeItemParentField();l=a._handleTreeItems(e,t,null,l)}return l}_handleTreeItems(i,r,n,s){let o=this;let u=[];for(let a=0;a<s.length;a++){let t=s[a];let l=t[i];let e=t[r];if(n&&n===e||!n&&!e){let e=o._handleTreeItems(i,r,l,s);t[o.treeDef.customName.children]=e;t[o.treeDef.customName.isParent]=e.length>0;u.push(t)}}return u}_setItemsCount(e=null,t=""){let a=this;e=e||a.getCurrRequestFilter();return new Promise(l=>{yunj.request(a.table.url,{[yunj.config("builder.id_key")]:a.tableId,[yunj.config("builder.async_type_key")]:"count",filter:e},"post").then(e=>{let t=e.data.count;a.itemsCount=yunj.isPositiveInteger(t)?t:0;l()}).catch(e=>{yunj.error(e)})})}_renderBefore(){let r=this;let e=`YUNJ_TABLE_${r.tableId}_GET_REQUEST_FILTER_DATA_EVENT_BIND_BY_LAY_TABLE`;if(yunj.isUndefined(t[e])){t[e]=true;b(d).bind(`yunj_table_${r.tableId}_get_request_filter_data`,function(e,t,l){let a=r.getCurrPk();let i=r.getCurrPksKey();if(!l[i]){return}t[i]=f.checkStatus(r.layTableId).data.map(e=>{return e[a]})})}}_renderAfter(){}async renderByDataChange(){let e=this;if(e.isSetState())await e.table.buildMap.state.renderCount();await e.render()}resize(){let e=this;f.resize(e.layTable.config.id)}reload(e=true){let t=this;let l={where:{id:t.tableId,type:"items",filter:t.getCurrRequestFilter(),sort:t.getCurrRequestSort()}};if(e)l.page={curr:1};t.layTable.reload(l)}setEventBind(){let a=this;b(d).bind(`yunj_table_${a.tableId}_filter_submit`,function(e){a.render()});let e=`.yunj-table-lay-table-box div[lay-id=${a.layTableId}] .layui-table-grid-down`;b(d).off("mousedown",e).on("mousedown",e,function(){a.layTableCurrTd=b(this).closest("td")});e=`.layui-table-tips-main .layui-btn-container[yunj-id=${a.tableId}] [lay-event]`;b(d).off("click",e).on("click",e,function(){if(!a.layTableCurrTd)return;let e=b(this);let t=e.attr("lay-event");let l=e.closest(".layui-table-tips").attr("times");layer.close(l);a.layTableCurrTd.find(`[lay-event="${t}"]`).first().click()});if(a.isSetToolbar()||a.isSetDefaultToolbar()){f.on(`toolbar(${a.layTableId})`,function(e){if(e.event.indexOf(a.layEventMark)!==-1)return a.handleLayEvent(e);switch(e.event){case"export":yunj.tableExport(a.table);break}})}f.on(`tool(${a.layTableId})`,function(e){if(e.event.indexOf(a.layEventMark)!==-1)return a.handleLayEvent(e)});f.on(`sort(${a.layTableId})`,function(e){a.fieldSort=["asc","desc"].indexOf(e.type)===-1?{}:{[e.field]:e.type};a.reload(false)})}handleLayEvent(n){let s=this;let[o,u,y]=s.parseLayEvent(n.event);let e=function(){let r=s.getCurrPk();let e=s.getCurrPksKey();switch(y.type){case"openPopup":let t={rawTable:s.tableId};let l=y.title;if(o===s.layEventLocation.action){let e=n.data[r];l+=` ${r}:${e}`;t[r]=e}yunj.openPopup(yunj.handlePageUrl(yunj.urlPushParam(y.url,t)),l,true);break;case"openTab":let a={rawTable:s.tableId};let i=y.title;if(o===s.layEventLocation.action){let e=n.data[r];i+=` ${r}:${e}`;a[r]=e}yunj.openTab(yunj.handlePageUrl(yunj.urlPushParam(y.url,a)),i,true);break;case"asyncEvent":y[e]=o===s.layEventLocation.action?[n.data[r]]:f.checkStatus(n.config.id).data.map(e=>{return e[r]});if((!yunj.isArray(y[e])||yunj.isEmptyArray(y[e]))&&o!==s.layEventLocation.defaultToolbar){yunj.msg("请勾选要操作的数据列");return}y.event=u;s.asyncEventRequest(y).catch(e=>{yunj.error(e)});break;default:console.log(`yunj_table_${s.tableId}_${u}`);b(d).trigger(`yunj_table_${s.tableId}_${u}`,[n])}};if(y.confirmText)yunj.confirm(y.confirmText,function(){e()});else e()}getCurrRequestSort(){return JSON.stringify(this.fieldSort)}asyncEventRequest(e){let i=this;let t=i.getCurrPksKey();let l={title:"操作请求",event:"",url:""};l[t]=[];e=yunj.objSupp(e,l);let a={state:i.getCurrState()};a[t]=e[t];let r={[yunj.config("builder.id_key")]:i.tableId,[yunj.config("builder.async_type_key")]:"event",[yunj.config("builder.async_event_key")]:e.event,filter:JSON.stringify(a)};return new Promise((a,t)=>{yunj.request({url:e.url?e.url:i.url,data:r,type:"post",loading:true}).then(e=>{let t=r.filter;let l=t.event;if(yunj.isObj(e.data)&&e.data.hasOwnProperty("reload")&&e.data.reload){i.renderByDataChange().then(()=>{i.asyncEventRequestDone(l,t,e)});a();return}i.asyncEventRequestDone(l,t,e);a()}).catch(e=>{t(e)})})}asyncEventRequestDone(e,t,l){let a=this;b(d).trigger(`yunj_table_${a.tableId}_event_done`,[e,t,l]);b(d).trigger(`yunj_table_${a.tableId}_event_${e}_done`,[t,l])}generateLayEvent(e,t,l){let a=this;return`${a.layEventMark}==>${e}==>${t}==>`+encodeURIComponent(JSON.stringify(l))}parseLayEvent(e){let t=this;let[l,a,i,r]=e.split("==>");r=JSON.parse(decodeURIComponent(r));return[a,i,r]}}e("TableBuildTable",a)});