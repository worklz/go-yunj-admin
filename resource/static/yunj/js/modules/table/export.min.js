layui.define(["cookie","yunj","jquery","laytpl","validate"],function(e){let t=window;let a=document;let r=layui.jquery;let n=layui.laytpl;let o=layui.cookie;let u=layui.validate;class l{constructor(e){this.table=e;this.tableId=e.id;this.tableBuildTable=e.getCurrBuildTable();this.itemsTotalCount=this.tableBuildTable.itemsCount;this.requestFilter=null;this.requestSort=this.tableBuildTable.getCurrRequestSort();this.file=null;this.isCanRequest=true;this.loadProgress=null;this.hasCheckedRow=false;this.cols=[];this.sheet=[];this.sheetRowNum=0;this.prompt().then(e=>this.init())}prompt(){let n=this;return new Promise((i,e)=>{let r=yunj.currPageId()+":"+n.tableId;let t=o.get(r);t=t&&yunj.isJson(t)?JSON.parse(t):{name:a.title?`${a.title}_${n.tableId}`:n.tableId,ext:"xlsx"};t.name=t.name.replace(/[^\u4e00-\u9fa5a-zA-Z0-9\_\-]+/g,"_");let l=`<div class="yunj-table-export-prompt-box">
                                    <div class="label">文件名</div>
                                    <div class="file-name">
                                        <input type="text" name="file_name" placeholder="汉字/字母/数字/_/-" value="${t.name}" autocomplete="off" class="layui-input">
                                    </div>
                                    <div class="file-ext">.xlsx</div>
                                </div>`;let s={type:1,title:"确认导出？",content:l,btn:["确认","取消"],shadeClose:true,yes:function(e,t){let l=t.find(".yunj-table-export-prompt-box");let s={name:l.find("input[name=file_name]").val(),ext:"xlsx"};u.create({rule:{name:"require|chsDash",ext:"require|in:xlsx"},message:{"name.require":"文件名不能为空","name.chsDash":"文件名仅允许汉字/字母/数字/下划线_/破折号-组合","ext.require":"文件格式不能为空","ext.in":"文件格式选择错误"}});u.checkTips(s);n.file=s;yunj.isExistParent()?parent.layer.close(e):layer.close(e);o.set(r,JSON.stringify(n.file));i("done")}};yunj.isExistParent()?parent.layer.open(s):layer.open(s)})}async init(){let e=this;await e.initResource();e.initData();e.exec()}async initResource(){let e=this;await yunj.includeXlsxStyle();return"done"}initData(){let e=this;e.setRequestFilter();e.isCanRequest=true;e.setCols();e.setSheetInit()}setRequestFilter(){let e=this;let t=e.table.getCurrPksKey();let l={convert:false};l[t]=true;let s=e.table.getCurrRequestFilter(l);e.hasCheckedRow=s[t].length>0;e.requestFilter=JSON.stringify(s)}setCols(){let e=this;let s=e.tableBuildTable.getCurrPk();let i=JSON.parse(JSON.stringify(e.tableBuildTable.layTable.config.cols))[0];for(let l=0;l<i.length;l++){let e=i[l];if(e.field===s||e.hasOwnProperty("hide")&&e.hide||e.templet.length>0&&/^#templet_[\w]*_action$/.test(e.templet)){i.splice(l,1);l--;continue}if(e.title.length<=0)e.title=e.field;let t=e.templet.substr(0,1)==="#"?r(e.templet).html():e.templet;e.tplObj=t.length>0?n(t):null;i[l]=e}e.cols=i}setSheetInit(){let i=this;let r=[];let n=[];for(let s=0,e=i.cols.length;s<e;s++){let e=i.cols[s];let t=XLSX.utils.encode_cell({c:s,r:0});r[t]={v:e.title,s:{fill:{fgColor:{rgb:"FFC0C0C0"}},font:{name:"宋体",sz:11},alignment:{vertical:"center",horizontal:"center"},border:{right:{style:"thin"},bottom:{style:"thin"}}}};let l=yunj.xlsx_sheet_cell_wch(e.title);l=l>10?l:10;n.push({wch:l})}r["!cols"]=n;i.sheet=r;i.sheetRowNum=1}exec(){let t=this;yunj.loadProgress({tips:`表格数据，正在下载中...`,rand_progress:false,done:e=>{e.set_tips(`表格数据，正在导出中...`);t.save()},close:e=>{t.isCanRequest=false}}).then(e=>{t.loadProgress=e;t.request()})}request(e=1){let r=this;if(!r.isCanRequest){return false}let t={[yunj.config("builder.id_key")]:r.tableId,[yunj.config("builder.async_type_key")]:"export",num:e,filter:r.requestFilter,sort:r.requestSort};yunj.request(r.table.url,t,"post").then(e=>{let i=e.data;i.items.map(e=>{e.is_export=true;return e});if(i.items.length>0){r.itemsPushSheet(i.items)}if(!r.hasCheckedRow){let e=i.isPage;let t=i.num|0;let l=i.limit|0;let s=t*l;if(e&&s<r.itemsTotalCount){let e=s*100/r.itemsTotalCount|0;e=e>99?99:e;r.loadProgress.reset_progress(e);r.request(t+1);return false}}r.loadProgress.reset_progress(100)}).catch(e=>{console.log(e);yunj.close(r.loadProgress.index);yunj.error(e)})}item_cell_val(t,l){let e=this;if(!l.tplObj)return t[l.field];try{let e=l.tplObj.render(t);return yunj.trim(r(e).text())}catch(e){console.log(e);return t[l.field]}}itemsPushSheet(e){let r=this;e.forEach(s=>{let i=r.sheetRowNum;for(let l=0,e=r.cols.length;l<e;l++){let e=r.cols[l];let t=XLSX.utils.encode_cell({c:l,r:i});r.sheet[t]={v:r.item_cell_val(s,e),s:{font:{name:"宋体",sz:11},alignment:{vertical:"center"}}}}r.sheetRowNum++})}save(){let e=this;e.sheet["!ref"]=XLSX.utils.encode_range({s:{c:0,r:0},e:{c:e.cols.length-1,r:e.sheetRowNum}});let t={SheetNames:["sheet"],Sheets:{sheet:e.sheet}};let l={bookType:e.file.ext,bookSST:false,type:"binary"};let s=XlsxStyle.write(t,l);let i=new Blob([yunj.str_to_array_buffer(s)],{type:"application/octet-stream"});yunj.download({name:`${e.file.name}.${e.file.ext}`,blob:i})}}let s=e=>{if(yunj.isMobile())return yunj.alert("抱歉！暂不支持移动端导出数据",{icon:"warn"});new l(e)};e("tableExport",s)});