layui.define(["yunj"],function(e){let l=window;let n=document;class o{constructor(e){this.name=e.name;this.url=e.url;this.blob=e.blob;this.size=null;this.loadProgress=null;this.xhr=null}async exec(){let e=this;await e.setSize();await e.request()}setSize(){let l=this;return new Promise((e,t)=>{if(l.blob){l.size=l.blob.size;e(true);return}let s=yunj.msg("文件连接中...",null,60*60*1e3);let r=new XMLHttpRequest;r.open("HEAD",l.url,true);r.onreadystatechange=()=>{yunj.close(s);if(r.readyState===4){if(r.status===200||r.status===0){l.size=r.getResponseHeader("Content-Length");e(true)}else{yunj.msg("文件连接异常");t(false)}}};r.send()})}request(){let t=this;let e,s;if(t.size<1048576){e=(t.size/1024).toFixed(1);s="KB"}else{e=(t.size/(1024*1024)).toFixed(2);s="MB"}let r=1e3+(e>20?Math.ceil((e-20)/30)*2e3:0);let l=`文件:${t.name}<br>大小:${e+s}`;yunj.loadProgress({tips:`${l}&nbsp;&nbsp;正在下载中...`,progress_timer_rate:r,done:e=>{e.set_tips(`${l}&nbsp;&nbsp;正在导出中...`)},close:e=>{if(t.xhr)t.xhr.abort()}}).then(e=>{t.loadProgress=e;if(t.blob){t.loadProgress.reset_progress(100);t.save_blob(t.blob);return}t.xhr=new XMLHttpRequest;t.xhr.open("GET",t.url,true);t.xhr.responseType="blob";t.xhr.onload=function(){if(t.xhr.status===200){t.loadProgress.reset_progress(100);t.save_blob(t.xhr.response)}};t.xhr.send()})}save_blob(e){let t=this;if(l.navigator.msSaveOrOpenBlob){navigator.msSaveBlob(e,t.name);return true}let s=window.URL.createObjectURL(e);t.save_url(s)}save_url(e){let t=this;let s=n.createElement("a");let r=n.querySelector("body");s.href=e;s.download=t.name;s.style.display="none";r.appendChild(s);s.click();r.removeChild(s);l.URL.revokeObjectURL(s.href)}}let t=(e,t="")=>{let s=yunj.isObj(e)?e:{url:e,name:t};s=yunj.objSupp(s,{name:"",url:"",blob:null});let r=new o(s);r.exec().then()};e("download",t)});