layui.define(["yunj","validateMethods"],function(e){let t=layui.validateMethods;class o{constructor(){this._rule={};this._message={};this._scene={};this._error=[];this._batch=false;this._methods=t;this._methodsAppendRules=[];this._checkScene="";this._checkRule={};this._data=null;this._dataTitle=null}create(e={}){let t=this;if(e.hasOwnProperty("rule"))t.rule(e.rule);if(e.hasOwnProperty("message"))t.message(e.message);if(e.hasOwnProperty("scene"))t.scene(e.scene);if(e.hasOwnProperty("batch"))t.batch(e.batch);if(e.hasOwnProperty("methods"))t.methods(e.methods);return t}rule(e={}){let t=this;t._rule=e;return t}message(e={}){let t=this;t._message=e;return t}scene(e={}){let t=this;t._scene=e;return t}setError(e,t,r){let n=this;n._error.push({field:e,rule:t,msg:r});return n}getError(){let e=this;return yunj.arrayColumn(e._error,"msg").join(",")}getFieldError(){let e=this;let r={};e._error.forEach(e=>{let t=e.field;if(!r.hasOwnProperty(t)){r[t]=""}r[t]+=(r[t]?",":"")+e.msg});return r}getRawError(){let e=this;return e._error}batch(e=false){let t=this;t._batch=e;return t}methods(t={}){let e=this;if(!yunj.isObj(t)){throw new Error("[methods]值错误")}let r={};for(let e in t)r[`method_${e}`]=t[e];e._methods=Object.assign({},r,e._methods);e._methodsAppendRules=Object.keys(t);return e}setSceneData(e,t={},s=""){let l=this;if(!yunj.isObj(e)){throw new Error("[data]值需为键值对对象")}if(!yunj.isObj(t)){throw new Error("[dataTitle]值需为键值对对象")}let i=l._rule;if(s){if(!l._scene.hasOwnProperty(s)){throw new Error("[scene]环境值错误")}let r={};let n=l._scene[s];for(let t=0,e=n.length;t<e;t++){let e=n[t];if(!i.hasOwnProperty(e)){throw new Error(`环境[${s}]下数据[${e}]验证规则不存在`)}r[e]=i[e]}l._checkScene=s;l._checkRule=r}else{l._checkScene="";l._checkRule=i}return l}check(c,f={},e=""){let y=this;y._error=[];y.setSceneData(c,f,e);if(y._error.length>0)return false;let t=y._checkRule;for(let a in t){if(!t.hasOwnProperty(a))continue;let u=c[a];let o=t[a].split("|");if(o.length<=0||o[0]!=="require"&&(u===undefined||u===null||u===""))continue;for(let h=0,e=o.length;h<e;h++){let e=o[h];if(e==="")continue;let[t,r]=e.indexOf(":")!==-1?e.split(":"):[e,""];let n=`method_${t}`;let s=null;if(y._methods.hasOwnProperty(n)){s=y._methods[n]}else if(typeof y[n]==="function"){s=y[n]}if(!s||!yunj.isFunction(s))continue;let l=s(u,r,c);if(l===true)continue;let i;if(yunj.isString(l)&&y._methodsAppendRules.indexOf(t)!==-1){i=l}else{let e=`${a}.${t}`;i=y._message.hasOwnProperty(e)?y._message[e]:(f.hasOwnProperty(a)?f[a]:a)+(yunj.isString(l)?l:"错误")}y.setError(a,e,i);if(!y._batch)return false}}return y._error.length<=0}checkTips(e,t={},r=""){let n=this;let s=n.check(e,t,r);if(s===true)return true;let l=n.getError();yunj.alert(l,{icon:"warn"});throw new Error(l)}method_table(s,e="",t={}){if(!yunj.isArray(s))return"格式错误";if(!e)return"验证规则[table]不能为空";let r=yunj.base64Decode(e);if(!yunj.isJson(r))return"验证规则[table]错误";let n=JSON.parse(r);if(!yunj.isArray(n))return"验证规则[table]错误";let l=yunj.arrayColumn(n,"verify","field");let i={};n.forEach(e=>{i[e.field]=`[${e.title}]`});let h=yunj.arrayColumn(n,"field");let u=new o;for(let n=0;n<s.length;n++){let e=s[n];let t="第"+(n+1)+"行";if(!yunj.isObj(e)){return`${t}格式错误`}if(yunj.isEmptyObj(e)){return`${t}不能为空`}let r=Object.keys(e);if(yunj.arrayDiff(h,r).length>0){return`${t}需所有表头传值`}if(!u.rule(l).check(e,i)){return t+u.getError()}}return true}}let r=new o;e("validate",r)});