layui.use(["jquery","yunj","validate","form"],function(){let e=window;let t=document;let l=layui.jquery;let o=layui.validate;let r=layui.form;class a{constructor(){this.rememberMeLocalStorageKey="admin_remember_me";this.usernameEl=null;this.passwordEl=null;this.captchaBoxEl=null;this.captchaCodeEl=null;this.captchaImgEl=null;this.rememberMeEl=null;this.btnSubmitEl=null;this.loadingTimer=null;this.init()}init(){let e=this;e.setData();e.setEventBind()}setData(){let e=this;e.usernameEl=l("#username");e.passwordEl=l("#password");e.captchaBoxEl=l(".captcha-box");e.captchaCodeEl=l("#captcha_code");e.captchaImgEl=l("#captcha_img");e.rememberMeEl=l("#remember_me");e.btnSubmitEl=l("#submit");e.initRememberMe();e.setCaptchaCode(true)}login(){let a=this;let t=a.btnSubmitEl;if(t.prop("disabled"))return;a.setBtnSubmitStatus(true);a.getFormData().then(e=>{yunj.request(t.data("url"),{data:e},"post").then(e=>{a.setRememberMe();location.href=e.data.url}).catch(e=>{yunj.error(e);a.setBtnSubmitStatus(false)})}).catch(e=>{yunj.error(e);a.setBtnSubmitStatus(false)})}getFormData(){let e=this;let a=e.usernameEl;let t=e.passwordEl;let l=e.captchaCodeEl;let r=e.captchaImgEl;let s={username:a.val(),password:t.val(),captchaCode:l.val(),captchaHash:r.data("hash")};let n={username:"账户",password:"密码",captchaCode:"验证码",captchaHash:"验证码"};let i=o.rule({username:"require|alphaDash|max:20",password:"require|alphaDash",captchaCode:"require|alphaNum|length:"+l.attr("maxlength"),captchaHash:"require|alphaNum"}).message({"username.alphaDash":"账户错误","username.max":"账户错误","password.alphaDash":"密码错误","captchaCode.alphaNum":"验证码错误","captchaCode.length":"验证码错误","captchaHash.require":"验证码错误","captchaHash.alphaNum":"验证码错误"}).check(s,n);return new Promise((t,a)=>{if(!i){a(o.getError());return}let l=yunj.randStr(16);let r=yunj.randStr(16);yunj.aesEncrypt(JSON.stringify(s),l,r).then(e=>{let a=encodeURIComponent(JSON.stringify({data:e,key:l,iv:r}));t(a)}).catch(e=>{a("环境异常")})})}setBtnSubmitStatus(e=false){let a=this;a.loadingTimer&&clearInterval(a.loadingTimer)&&(a.loadingTimer=null);if(e){let e=0;a.loadingTimer=setInterval(()=>{a.btnSubmitEl.val("登录中"+".".repeat(e++%3+1))},300)}else{a.btnSubmitEl.val("登录")}a.btnSubmitEl.attr("disabled",e)}initRememberMe(){let e=this;let a=yunj.getLocalStorage(e.rememberMeLocalStorageKey);if(!a){return}e.usernameEl.val(a.username?yunj.base64Decode(a.username):"");e.passwordEl.val(a.password?yunj.base64Decode(a.password):"");e.rememberMeEl.prop("checked",a.rememberMe);r.render("checkbox")}setRememberMe(){let e=this;let a=e.rememberMeEl.prop("checked");if(!a){yunj.clearLocalStorage(e.rememberMeLocalStorageKey);return}let t={username:yunj.base64Encode(e.usernameEl.val()),password:yunj.base64Encode(e.passwordEl.val()),rememberMe:true};yunj.setLocalStorage(e.rememberMeLocalStorageKey,t)}setCaptchaCode(e=false){let a=this;let t=a.captchaBoxEl;if(!e&&t.hasClass("loading"))return;t.addClass("loading");yunj.request(t.data("url"),null,"post").then(e=>{a.captchaImgEl.attr("src","data:image/png;base64,"+e.data.content).data("hash",e.data.hash);t.removeClass("loading")}).catch(e=>{yunj.error(e);t.removeClass("loading")})}setEventBind(){let a=this;a.captchaImgEl.on("click",function(e){a.setCaptchaCode();e.stopPropagation()});a.btnSubmitEl.on("click",function(e){a.login();e.stopPropagation()});l(t).on("keyup",function(e){if(e.keyCode===13){let e=l(t).find("input:focus");if(e.length>0&&yunj.trim(e.val())&&l(t).find(".layui-layer").length<=0){a.login()}}e.stopPropagation()})}}l(t).ready(function(){e.yunj.tips=new a})});