layui.use(["jquery","yunj","layer","element","md5"],function(){let l=window;let a=document;let r=layui.jquery;let d=layui.layer;let s=layui.element;let i=layui.md5;class e{constructor(){this.pageTabFilter="xbs_tab";this.leftNavEl=null;this.leftNavOpenPageContentMask=null;this.iframeTabBoxEl=null;this.homeTabLayId="";this.tabRecordsKey="tabRecords";this.iframeTabClosePanelEl=null;this.iframeTabClosePanelContentMask=null;this.globalSearchEl=null;this.globalSearchRecordsKey="globalSearchRecords";this.globalSearchNoResultKey="no_result";this.fileDownloadEl=null;this.init()}init(){let e=this;e.initAttr();e.setEventBind();e.initRecordsTab()}initAttr(){let e=this;let t=yunj.getLoginMemberId();e.leftNavEl=r(".left-nav");e.leftNavOpenPageContentMask=r("#left_nav_open_page_content_mask");e.iframeTabBoxEl=r(".page-content .layui-tab-title");e.iframeTabClosePanelEl=r("#tab_close_panel");e.iframeTabClosePanelContentMask=r("#tab_close_panel_content_mask");e.homeTabLayId=e.iframeTabBoxEl.find("li>.home").attr("lay-id");e.tabRecordsKey=t+"_"+e.tabRecordsKey;e.globalSearchEl=r(".header .global-search");if(e.globalSearchEl.length>=0){e.globalSearchRecordsKey=t+"_"+e.globalSearchRecordsKey}e.fileDownloadEl=r(".header .file-download")}initRecordsTab(){let l=this;let a=l.homeTabLayId;let{tabIds:e,records:i}=l.getTabRecordsLocalStorage();for(let t in i){if(!i.hasOwnProperty(t)){continue}let e=i[t];if(!e.hasOwnProperty("args")){continue}if(e.hasOwnProperty("isCurr")&&e.isCurr){a=t}l.openTab(e.args)}s.tabChange(l.pageTabFilter,a)}leftNavOpen(){let e=this;let t=e.leftNavEl;t.animate({width:"220px"},100);r(".page-content").animate({left:"220px"},100);r(".left-nav i").css("font-size","14px");r(".left-nav cite,.left-nav .li-icon-right").show();if(r(l).width()<768)e.leftNavOpenPageContentMask.show()}leftNavClose(){let e=this;let t=e.leftNavEl;r(".left-nav .open").click();r(".left-nav i").css("font-size","18px");t.animate({width:"60px"},100);r(".left-nav cite,.left-nav .li-icon-right").hide();r(".page-content").animate({left:"60px"},100);if(r(l).width()<768)e.leftNavOpenPageContentMask.hide()}showGlobalSearchResult(){let i=this;let e=i.globalSearchEl;let l=e.find(".result");let t=l.find(".item");t.css("display","none");let a=e.find("input[name=global_search_keywords]");let n=a.val();let o=[];let s=i.getGlobalSearchResultRecordSortKeys();if(n){let a=1;let i=t.length;t.each(function(e){let t=r(this).data("desc");let l=new RegExp(n,"i");if(t&&t.search(l)!==-1){let e=r(this).data("key");let t=-1;if((t=s.indexOf(e))!==-1){o[t]=e}else{o[i+a]=e}a++}})}else{o=JSON.parse(JSON.stringify(s));let l=o.length;let a=0;t.each(function(e){let t=r(this).data("key");if(t===i.globalSearchNoResultKey||o.indexOf(t)!==-1)return true;o[l+a]=t;a++})}if(o.length<=0)o=[i.globalSearchNoResultKey];o=yunj.arrayUnique(o);o.forEach(function(e){let t=l.find(`.item[data-key=${e}]`);l.append(t);t.show()});e.find(".result-mask").show();l.css("display","flex")}hideGlobalSearchResult(){let e=this;let t=e.globalSearchEl;t.find(".result").css("display","none");t.find(".result-mask").hide();t.find(".input-box input[name=global_search_keywords]").val("")}getGlobalSearchResultRecordSortKeys(){let e=this;let t=[];let l=yunj.getLocalStorage(e.globalSearchRecordsKey,[]);for(let e=0;e<l.length;e++){t.push(l[e].key)}return yunj.arrayUnique(t)}setGlobalSearchResultRecord(t){let e=this;let l=yunj.getLocalStorage(e.globalSearchRecordsKey,[]);for(let e=0;e<l.length;e++){if(l[e].key===t){l.splice(e,1);break}}l.unshift({key:t,time:yunj.currTimestamp()});yunj.setLocalStorage(e.globalSearchRecordsKey,l)}showFileDownloadItems(){let e=this;let t=e.fileDownloadEl;t.find(".items-mask").show();t.find(".items-box").css("display","flex")}hideFileDownloadItems(){let e=this;let t=e.fileDownloadEl;t.find(".items-box").css("display","none");t.find(".items-mask").hide()}removeFileDownloadItem(e){let t=this;let l=t.fileDownloadEl;l.find(`#${e}`).remove();if(l.find(".items-box").html().trim()===""){l.find(".items-box").html("暂无文件下载中...")}}setEventBind(){let n=this;n.leftNavEl.on("click","#nav li",function(e){let t=r(this);if(n.leftNavEl.width()<200)n.leftNavOpen();n.leftNavEl.find("a").removeClass("active");t.children("a").addClass("active");if(t.children(".sub-menu").length){if(t.hasClass("open")){t.removeClass("open");t.find(".li-icon-right").removeClass("layui-icon-down").addClass("layui-icon-left");t.children(".sub-menu").stop(true,true).slideUp();t.siblings().children(".sub-menu").slideUp()}else{t.addClass("open");t.children("a").find(".li-icon-right").removeClass("layui-icon-left").addClass("layui-icon-down");t.children(".sub-menu").stop(true,true).slideDown();t.siblings().children(".sub-menu").stop(true,true).slideUp();t.siblings().find(".li-icon-right").removeClass("layui-icon-down").addClass("layui-icon-left");t.siblings().removeClass("open")}}e.stopPropagation()});n.leftNavEl.on("mouseenter","#nav .left-nav-li",function(e){let t=r(this);if(n.leftNavEl.width()<200)t.attr("lay-tips-index",d.tips(t.attr("lay-tips"),t))});n.leftNavEl.on("mouseout","#nav .left-nav-li",function(e){let t=r(this);let l=t.attr("lay-tips-index");if(l){d.close(l);t.attr("lay-tips-index",0)}});r(".header .action .left-open i").click(function(e){n.leftNavEl.width()>200?n.leftNavClose():n.leftNavOpen()});n.leftNavEl.on("click",function(e){if(r(l).width()>=768||n.leftNavEl.width()>200||r(e.target).attr("class")!==n.leftNavEl.attr("class"))return;n.leftNavOpen()});r(a).on("click",function(e){if(r(l).width()>=768||n.leftNavEl.width()<200||r(e.target).attr("id")!==n.leftNavOpenPageContentMask.attr("id"))return;n.leftNavClose()});n.iframeTabBoxEl.on("contextmenu","li",function(e){e.preventDefault()});n.iframeTabBoxEl.on("mousedown","li",function(a){let i=r(this);switch(a.button){case 0:break;case 1:i.find(".layui-tab-close").click();break;case 2:let e=i.position().left;let t=i.width();let l=i.attr("lay-id");n.iframeTabClosePanelEl.css({left:e+t/2}).show().attr("lay-id",l||null);n.iframeTabClosePanelContentMask.show();break}a.stopPropagation()});n.iframeTabClosePanelEl.on("click","dd",function(e){let t=n.iframeTabBoxEl;let l=r(this).attr("data-type");let a=n.iframeTabClosePanelEl.attr("lay-id");let i=null;if(l==="this"&&a){i=t.find(`li[lay-id=${a}]`)}else if(l==="other"){t.find("li").eq(0).find(".layui-tab-close").remove();i=t.find(a?`li[lay-id!=${a}]`:"li[lay-id]")}else if(l==="all"){i=t.find("li[lay-id]")}i&&i.find(".layui-tab-close").click();n.iframeTabClosePanelEl.hide();n.iframeTabClosePanelContentMask.hide()});r(".page-content,#tab_close_panel_content_mask,.container,.left-nav").click(function(e){n.iframeTabClosePanelEl.hide();n.iframeTabClosePanelContentMask.hide()});r(".set-theme").on("click",function(e){d.open({type:5,title:"主题设置",shade:.2,area:["295px","90%"],offset:"rb",maxmin:true,shadeClose:true,closeBtn:false,anim:2,content:r("#theme_tpl").html(),success:function(e,t){yunj.theme.setThemeTplActive();r(".theme-box li").on("click",function(){yunj.theme.set(r(this).data("code"));yunj.close(t)})}});return false});s.on(`tab(${n.pageTabFilter})`,function(){let e=this.getAttribute("lay-id");n.setSelectedTabRecordsLocalStorage(e);if(!e)return;let t=r(a).find(`iframe[tab-id=${e}]`);if(t.length<=0)return;let l=t[0].contentWindow;try{if(!l.hasOwnProperty("yunj")||!yunj.isObj(l.yunj)||!l.yunj.hasOwnProperty("table")||!yunj.isObj(l.yunj.table))return;let a=l.yunj.table;for(let l in a){if(!a.hasOwnProperty(l))continue;let e=a[l];let t=e.getCurrBuildTable();t&&t.resize()}}catch(e){console.log(e)}});s.on(`tabBeforeDelete(${n.pageTabFilter})`,function(e){let t=this.getAttribute("lay-id");n.delTabRecordsLocalStorage(t)});n.globalSearchEl.on("click",".input-box",function(e){if(!n.globalSearchEl.find(".result").is(":visible")){n.showGlobalSearchResult()}e.stopPropagation()});n.globalSearchEl.on("keyup",".input-box input[name=global_search_keywords]",function(e){n.showGlobalSearchResult()});n.globalSearchEl.on("click",".result>.item",function(e){let t=r(this).data("key");if(!t||t===n.globalSearchNoResultKey)return;n.setGlobalSearchResultRecord(t);n.hideGlobalSearchResult()});n.fileDownloadEl.on("click",".icon-box",function(e){if(n.fileDownloadEl.find(".items-box").is(":visible")){n.hideFileDownloadItems()}else{n.showFileDownloadItems()}e.stopPropagation()});n.fileDownloadEl.on("click",".items-box .item .item-action .remove",function(e){let t=r(this).closest(".item").attr("id");n.removeFileDownloadItem(t);e.stopPropagation()});r(a).on("click",function(e){if(!r(e.target).closest(".header .global-search .result").length){if(n.globalSearchEl.find(".result").is(":visible")){n.hideGlobalSearchResult()}}if(!r(e.target).closest(".header .file-download .items-box").length){if(n.fileDownloadEl.find(".items-box").is(":visible")){n.hideFileDownloadItems()}}})}pageId(e){let t=this;e=e.substr(0,4)==="http"?e:location.protocol+"//"+location.host+e;return i(e)}openTab(e,t="",l=null){let a=this;let i=yunj.objSupp(yunj.isObj(e)?e:{url:e,title:t,rawPage:l},{url:"",title:"",rawPage:null});if(i.rawPage)i.url=yunj.urlPushParam(i.url,"rawPage",i.rawPage);let n=a.pageId(i.url);let o=a.pageTabFilter;for(let e=0,t=r(".x-iframe").length;e<t;e++){if(r(".x-iframe").eq(e).attr("tab-id")===n){s.tabChange(o,n);return}}d.closeAll();s.tabAdd(o,{title:i.title,content:`<iframe tab-id="${n}" frameborder="0" src="${i.url}" scrolling="yes" class="x-iframe"></iframe>`,id:n});a.addTabRecordsLocalStorage(n,i);s.tabChange(o,n);a.iframeTabBoxEl.find(`li[lay-id=${n}] .layui-tab-close`).unbind("click").on("click",function(e){a.closeTab(n);e.stopPropagation()})}openPopup(e,t="",l=null,a=null,i=null){let n=this;let o=yunj.objSupp(yunj.isObj(t)?t:{url:e,title:t,rawPage:l,w:a,h:i},{url:"",title:"",rawPage:null,w:null,h:null});let s="auto";if(o.w!==null&&i!==null){o.w=o.w.toString();o.h=o.h.toString();s=[o.w.indexOf("%")!==-1?o.w:`${o.w}px`,o.h.indexOf("%")!==-1?o.h:`${o.h}px`]}else{s=["80%","80%"]}let r={isPopup:"yes"};o.url=yunj.urlPushParam(o.url,r);let c={id:n.pageId(e),type:2,title:o.title,content:o.rawPage?yunj.urlPushParam(o.url,"rawPage",o.rawPage):o.url,skin:"popup-page",area:s,closeBtn:1,shadeClose:true,shade:.2,maxmin:true,success:function(e,t){},end:function(){}};d.closeAll();return d.open(c)}closeTab(e){let t=this;let l=t.iframeTabBoxEl.find(`li[lay-id=${e}]`).index();let a=t.iframeTabBoxEl.find("li").length;let i=l<a-1?l+1:l-1;t.iframeTabBoxEl.find("li").eq(i).click();s.tabDelete(t.pageTabFilter,e)}getTabRecordsLocalStorage(){let e=this;return yunj.getLocalStorage(e.tabRecordsKey,{tabIds:[],records:{}})}setTabRecordsLocalStorage(e,t){let l=this;yunj.setLocalStorage(l.tabRecordsKey,{tabIds:e,records:t},60*60+24)}delTabRecordsLocalStorage(e){let t=this;let{tabIds:l,records:a}=t.getTabRecordsLocalStorage();let i=l.indexOf(e);if(i!==-1){l=[...l.slice(0,i),...l.slice(i+1)]}if(a.hasOwnProperty(e)){delete a[e]}t.setTabRecordsLocalStorage(l,a)}addTabRecordsLocalStorage(e,t){let l=this;let{tabIds:a,records:i}=l.getTabRecordsLocalStorage();if(a.indexOf(e)===-1){a.push(e)}i[e]={args:t};l.setTabRecordsLocalStorage(a,i)}setSelectedTabRecordsLocalStorage(e){let t=this;let{tabIds:l,records:a}=t.getTabRecordsLocalStorage();if(e!==t.homeTabLayId&&(l.indexOf(e)===-1||!a.hasOwnProperty(e))){return}for(let e in a){if(!a.hasOwnProperty(e)){continue}a[e].isCurr=false}e!==t.homeTabLayId&&a.hasOwnProperty(e)&&(a[e].isCurr=true)&&t.setTabRecordsLocalStorage(l,a)}redirectTab(e=null){let t=this;t.iframeTabBoxEl.find(`li${e===null?".home":"[lay-id="+e+"]"}`).click();return e}currTabPageId(){let e=this;let t=e.iframeTabBoxEl.find("li.layui-this");if(t.length<=0)return null;let l=t.eq(0).attr("lay-id");return l&&yunj.isString(l)?l:null}currPopupPageId(e=null){let t=this;e=e||r(".layui-layer-iframe.popup-page");if(e.length<=0)return null;return e.find(".layui-layer-content").eq(0).attr("id")}}l.yunj.page=new e});